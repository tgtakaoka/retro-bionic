          0 :                    ;;; -*- mode: asm; mode: flyspell-prog; -*-
          0 :                            include "tms370.inc"
(1)       0 :                    ;;; -*- mode: asm; mode: flyspell-prog; -*-
(1)       0 :                    ;;; TMS370
(1)       0 :                            cpu     tms370
(1)       0 :                    ;;; Status Register
(1)       0 : =80                ST_C:   equ  10000000B          ; set to 1 if carry occurred
(1)       0 : =40                ST_N:   equ  01000000B          ; set to 1 if result is negative
(1)       0 : =20                ST_Z:   equ  00100000B          ; set to 1 if result is zero
(1)       0 : =10                ST_V:   equ  00010000B          ; set to 1 if result is overflow
(1)       0 : =8                 ST_IE2: equ  00001000B          ; if 1, level 2 interrupt is enabled
(1)       0 : =4                 ST_IE1: equ  00000100B          ; if 1, level 1 interrupt is enabled
(1)       0 :                    ;;; Vector
(1)       0 : =7FF8              VEC_INT3:       equ     7FF8H   ; #INT2 interrupt
(1)       0 : =7FFA              VEC_INT2:       equ     7FFAH   ; #INT2 interrupt
(1)       0 : =7FFC              VEC_INT1:       equ     7FFCH   ; #INT1 interrupt
(1)       0 : =7FFE              VEC_RESET:      equ     7FFEH   ; #RESET vector
(1)       0 :                    ;;; Trap Vector
(1)       0 : =7FDE              VEC_TRAP0:      equ     7FDEH
(1)       0 : =7FDC              VEC_TRAP1:      equ     7FDCH
(1)       0 : =7FDA              VEC_TRAP2:      equ     7FDAH
(1)       0 : =7FD8              VEC_TRAP3:      equ     7FD8H
(1)       0 : =7FD6              VEC_TRAP4:      equ     7FD6H
(1)       0 : =7FD4              VEC_TRAP5:      equ     7FD4H
(1)       0 : =7FD2              VEC_TRAP6:      equ     7FD2H
(1)       0 : =7FD0              VEC_TRAP7:      equ     7FD0H
(1)       0 : =7FCE              VEC_TRAP8:      equ     7FCEH
(1)       0 : =7FCC              VEC_TRAP9:      equ     7FCCH
(1)       0 : =7FCA              VEC_TRAP10:     equ     7FCAH
(1)       0 : =7FC8              VEC_TRAP11:     equ     7FC8H
(1)       0 : =7FC6              VEC_TRAP12:     equ     7FC6H
(1)       0 : =7FC4              VEC_TRAP13:     equ     7FC4H
(1)       0 : =7FC2              VEC_TRAP14:     equ     7FC2H
(1)       0 : =7FC0              VEC_TRAP15:     equ     7FC0H
(1)       0 :                    ;;; System Control and Configuration Registers
(1)       0 : =1010              SCCR0:          equ     1010H
(1)       0 : =40                OSC_POWER:      equ     01000000B
(1)       0 : =1011              SCCR1:          equ     1011H
(1)       0 : =10                AUTO_WAIT_DISABLE:      equ     00010000B
(1)       0 : =1012              SCCR2:          equ     1012H
(1)       0 : =1017              INT1:           equ     1017H
(1)       0 : =1018              INT2:           equ     1018H
(1)       0 : =1019              INT3:           equ     1019H
(1)       0 : =80                INT_FLAG:       equ     10000000B ; INTx Flag 1:transition detected
(1)       0 : =10                INT_DIR:        equ     00010000B ; INTx Direction 1:output 0:input/interrupt
(1)       0 : =8                 INT_DATA:       equ     00001000B ; INTx Data out
(1)       0 : =4                 INT_POLALITY:   equ     00000100B ; INTx Polarity 1:rising 0:falling
(1)       0 : =2                 INT_PRIORITY:   equ     00000010B ; INTx Priority 1:level2 0:level1
(1)       0 : =1                 INT_ENABLE:     equ     00000001B ; INTx Enable 1:enable 0:disable
          0 :
          0 :                    ;;; MC6850 Asynchronous Communication Interface Adapter
          0 : =10F0              ACIA:   equ     10F0H
          0 :                            include "mc6850.inc"
(1)       0 :                    ;;; -*- mode: asm; mode: flyspell-prog; -*-
(1)       0 :                    ;;; MC6850
(1)       0 :                    ;;; Asynchronous Communication Interface Adapter
(1)       0 : =10F0              ACIA_control:   equ     ACIA+0
(1)       0 : =10F0              ACIA_status:    equ     ACIA+0
(1)       0 : =10F1              ACIA_data:      equ     ACIA+1
(1)       0 :                            ;;  Counter Divider Select Bits
(1)       0 : =3                 CDS_gm:         equ     11B             ; Group mask
(1)       0 : =0                 CDS_DIV1_gc:    equ     00000000B       ; /1
(1)       0 : =1                 CDS_DIV16_gc:   equ     00000001B       ; /16
(1)       0 : =2                 CDS_DIV64_gc:   equ     00000010B       ; /64
(1)       0 : =3                 CDS_RESET_gc:   equ     00000011B       ; Master Reset
(1)       0 :                            ;;  Word Select Bits
(1)       0 : =1C                WSB_gm:         equ     00011100B       ; Group mask
(1)       0 : =0                 WSB_7E2_gc:     equ     00000000B       ; 7 Bits + Even Parity + 2 Stop Bits
(1)       0 : =4                 WSB_7O2_gc:     equ     00000100B       ; 7 bits + Odd Parity  + 2 Stop Bits
(1)       0 : =8                 WSB_7E1_gc:     equ     00001000B       ; 7 bits + Even Parity + 1 Stop Bits
(1)       0 : =C                 WSB_7O1_gc:     equ     00001100B       ; 7 bits + Odd Parity  + 1 Stop Bits
(1)       0 : =10                WSB_8N2_gc:     equ     00010000B       ; 8 bits + No Parity   + 2 Stop Bits
(1)       0 : =14                WSB_8N1_gc:     equ     00010100B       ; 8 bits + No Parity   + 1 Stop Bits
(1)       0 : =18                WSB_8E1_gc:     equ     00011000B       ; 8 bits + Even Parity + 1 Stop Bits
(1)       0 : =1C                WSB_8O1_gc:     equ     00011100B       ; 8 bits + Odd Parity  + 1 Stop Bits
(1)       0 :                            ;;  Transmit Control Bits
(1)       0 : =60                TCB_gm:         equ     01100000B       ; Group mask
(1)       0 : =0                 TCB_DI_gc:      equ     00000000B       ; RTS=Low,  Tx Interrupt Disabled
(1)       0 : =20                TCB_EI_gc:      equ     00100000B       ; RTS=Low,  Tx Interrupt Enabled
(1)       0 : =40                TCB_RTS_gc:     equ     01000000B       ; RTS=High, Tx Interrupt Disabled
(1)       0 : =60                TCB_BREAK_gc:   equ     01100000B       ; RTS=Low,  Tx Interrupt Disabled
(1)       0 :                                                    ; Transmit Break Level
(1)       0 : =80                RIEB_bm:        equ     10000000B       ; Receive Interrupt Enable Bit mask
(1)       0 :                    ;;; Status register
(1)       0 : =1                 RDRF_bm:        equ     00000001B       ; Receive Data Register Full
(1)       0 : =2                 TDRE_bm:        equ     00000010B       ; Transmit Data Register Empty
(1)       0 : =4                 DCDF_bm:        equ     00000100B       ; Data Carrier Detect Flag
(1)       0 : =8                 CTSF_bm:        equ     00001000B       ; Clear To Send Flag
(1)       0 : =10                FERR_bm:        equ     00010000B       ; Frame Error Flag
(1)       0 : =20                OVRN_bm:        equ     00100000B       ; Receiver Overrun Flag
(1)       0 : =40                PERR_bm:        equ     01000000B       ; Parity Error Flag
(1)       0 : =80                IRQF_bm:        equ     10000000B       ; Interrupt Request Flag
          0 : =94                RX_INT_TX_NO:   equ     WSB_8N1_gc|RIEB_bm
          0 :
       3000 :                            org     3000H
       3000 : =80                rx_queue_size:  equ     128
       3000 :                    rx_queue:       .block  rx_queue_size
       3080 :
       3080 :                    ;;; Internal registers
         C0 :                            org     00C0H
         C0 : =BF                stack:  equ     $-1      ; TMS370's SP is pre-increment/post-decrement
         C0 :
       7FFC :                            org     VEC_INT1
       7FFC : 20 B2                      .word   isr_int1
       7FFE :
       7FFE :                            org     VEC_RESET
       7FFE : 20 00                      .word   initialize
       8000 :
       7FC0 :                            org     VEC_TRAP15
       7FC0 : 7F C0                      .word   VEC_TRAP15
       7FC2 :
       2000 :                            org     2000H
       2000 :                    initialize:
       2000 : 52 BF                      mov     #stack, B
       2002 : FD                         ldsp
       2003 : 88 30 00 03                movw    #rx_queue, R3
       2007 : 52 80                      mov     #rx_queue_size, B
       2009 : 8E 20 40                   call    queue_init
       200C :                    ;;; initialize ACIA
       200C : F7 03 F0                   mov     #CDS_RESET_gc, ACIA_control ; Master reset
       200F : F7 94 F0                   mov     #RX_INT_TX_NO, ACIA_control
       2012 : F7 01 F2                   mov     #1, ACIA+2        ; INT1 for Rx
       2015 : F7 01 17                   mov     #INT_ENABLE, INT1 ; enable falling #INT1
       2018 :
       2018 :                    loop:
       2018 : F0 0C                      eint
       201A : 88 30 00 03                movw    #rx_queue, R3
       201E : F0 00                      dint                    ; (clear all ST bits)
       2020 : 8E 20 88                   call    queue_remove
       2023 : 07 F3                      jnc     loop
       2025 : F0 0C                      eint                    ; EINT clear ST
       2027 : B0                         tst     A
       2028 : 02 0E                      jz      halt_to_system
       202A : 8E 20 39                   call    putchar
       202D : 2D 0D                      cmp     #0DH, A
       202F : 06 E7                      jne     loop
       2031 : 22 0A                      mov     #0AH, A
       2033 : 8E 20 39                   call    putchar
       2036 : 00 E0                      jmp     loop
       2038 :                    halt_to_system:
       2038 : E0                         trap    15
       2039 :
       2039 :                    putchar:
       2039 : A7 02 F0 FC                btjz    #TDRE_bm, ACIA_status, putchar
       203D : 21 F1                      mov     A, ACIA_data
       203F : F9                         rts
       2040 :
       2040 :                            include "queue.inc"
(1)    2040 :                    ;;; -*- mode: asm; mode: flyspell-prog; -*-
(1)    2040 :                    ;;; [queue] queue structure
(1)    2040 : =0                 queue_len:      equ     0       ; queue length
(1)    2040 : =1                 queue_size:     equ     1       ; buffer size
(1)    2040 : =2                 queue_put:      equ     2       ; queue put index
(1)    2040 : =3                 queue_get:      equ     3       ; queue get index
(1)    2040 : =4                 queue_buf:      equ     4       ; buffer start offset
(1)    2040 :
(1)    2040 :                    ;;; [queue] Initialize queue
(1)    2040 :                    ;;; @param R2:R3 queue work space pointer
(1)    2040 :                    ;;; @param B queue work space size
(1)    2040 :                    ;;; @clobber A B R2:R3
(1)    2040 :                    queue_init:
(1)    2040 : B5                         clr     A
(1)    2041 : 9B 03                      mov     A, @R3          ; queue_len
(1)    2043 : 62                         mov     B, A
(1)    2044 : 2A 04                      sub     #queue_buf, A
(1)    2046 : D3 03                      inc     R3
(1)    2048 : 9B 03                      mov     A, @R3          ; queue_size
(1)    204A : 5A 02                      sub     #queue_put, B   ; offset queue_len and queue_size
(1)    204C : D3 03                      inc     R3              ; R2:R3=&queue_put
(1)    204E : B5                         clr     A
(1)    204F :                    queue_init_loop:
(1)    204F : 9B 03                      mov     A, @R3
(1)    2051 : D3 03                      inc     R3
(1)    2053 : CA FA                      djnz    B, queue_init_loop
(1)    2055 : F9                         rts
(1)    2056 :
(1)    2056 :                    ;;; [queue] Add an element to queue
(1)    2056 :                    ;;; @param R2:R3 queue work space pointer
(1)    2056 :                    ;;; @param A an element
(1)    2056 :                    ;;; @return ST.C 0 if queue is full
(1)    2056 :                    ;;; @clobber R2:R3
(1)    2056 :                    queue_add:
(1)    2056 : B8                         push    A
(1)    2057 : 9A 03                      mov     @R3, A          ; A=queue_len
(1)    2059 : F4 ED 01 03                cmp     queue_size(R3), A
(1)    205D : 09 02                      jl      queue_add_element
(1)    205F : B9                         pop     A               ; ST.C=0
(1)    2060 : F9                         rts
(1)    2061 :                    queue_add_element:
(1)    2061 : B3                         inc     A
(1)    2062 : 9B 03                      mov     A, @R3          ; queue_len++
(1)    2064 : F4 EA 02 03                mov     queue_put(R3), A
(1)    2068 : 28 04                      add     #queue_buf, A
(1)    206A : D8 03                      push    R3              ; save pointer
(1)    206C : 48 00 03                   add     A, R3           ; R2:R3=&queue_buf[queue_put]
(1)    206F : F1 FF                      mov     -1(SP), A       ; element
(1)    2071 : 9B 03                      mov     A, @R3          ; store element
(1)    2073 : D9 03                      pop     R3              ; restore pointer
(1)    2075 : F4 EA 02 03                mov     queue_put(R3), A
(1)    2079 : B3                         inc     A
(1)    207A : F4 ED 01 03                cmp     queue_size(R3), A
(1)    207E : 09 01                      jl      queue_add_return
(1)    2080 : B5                         clr     A               ; wraparound
(1)    2081 :                    queue_add_return:
(1)    2081 : F4 EB 02 03                mov     A, queue_put(R3) ; update queue_put
(1)    2085 : B9                         pop     A
(1)    2086 : F8                         setc                    ; ST.C=1
(1)    2087 : F9                         rts
(1)    2088 :
(1)    2088 :                    ;;; [queue] Remove an element from queue
(1)    2088 :                    ;;; @param R2:R3 queue work space pointer
(1)    2088 :                    ;;; @return A an element
(1)    2088 :                    ;;; @return ST.C 0 if queue is empty
(1)    2088 :                    queue_remove:
(1)    2088 : 9A 03                      mov     @R3, A          ; A=queue_len, ST.C=0
(1)    208A : 02 25                      jz      queue_remove_end
(1)    208C :                    queue_remove_elem:
(1)    208C : B2                         dec     A
(1)    208D : 9B 03                      mov     A, @R3          ; queue_len--
(1)    208F : F4 EA 03 03                mov     queue_get(R3), A
(1)    2093 : 28 04                      add     #queue_buf, A
(1)    2095 : D8 03                      push    R3              ; save pointer
(1)    2097 : 48 00 03                   add     A, R3           ; R2:R3=&queue_buf[queue_get]
(1)    209A : 9A 03                      mov     @R3, A          ; remove element
(1)    209C : D9 03                      pop     R3              ; restore pointer
(1)    209E : B8                         push    A               ; save element
(1)    209F : F4 EA 03 03                mov     queue_get(R3), A
(1)    20A3 : B3                         inc     A
(1)    20A4 : F4 ED 01 03                cmp     queue_size(R3), A
(1)    20A8 : 09 01                      jl      queue_remove_return
(1)    20AA : B5                         clr     A               ; wraparound
(1)    20AB :                    queue_remove_return:
(1)    20AB : F4 EB 03 03                mov     A, queue_get(R3)
(1)    20AF : B9                         pop     A               ; restore element
(1)    20B0 : F8                         setc
(1)    20B1 :                    queue_remove_end:
(1)    20B1 : F9                         rts
       20B2 :
       20B2 :                    isr_int1:
       20B2 : A3 7F 17                   and     #~INT_FLAG & 0FFH, INT1 ; clear INT1_FLAG
       20B5 : A7 80 F0 17                btjz    #IRQF_bm, ACIA_status, isr_int1_return
       20B9 : A7 01 F0 13                btjz    #RDRF_bm, ACIA_status, isr_int1_return
       20BD : B8                         push    A
       20BE : 80 F1                      mov     ACIA_data, A
       20C0 : D8 02                      push    R2
       20C2 : D8 03                      push    R3
       20C4 : 88 30 00 03                movw    #rx_queue, R3
       20C8 : 8E 20 56                   call    queue_add
       20CB : D9 03                      pop     R3
       20CD : D9 02                      pop     R2
       20CF : B9                         pop     A
       20D0 :                    isr_int1_return:
       20D0 : FA                         rti
