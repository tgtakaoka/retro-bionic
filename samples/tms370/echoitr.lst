          0 :                    ;;; -*- mode: asm; mode: flyspell-prog; -*-
          0 :                            include "tms370.inc"
(1)       0 :                    ;;; -*- mode: asm; mode: flyspell-prog; -*-
(1)       0 :                    ;;; TMS370
(1)       0 :                            cpu     tms370
(1)       0 :                    ;;; Status Register
(1)       0 : =80                ST_C:   equ  10000000B          ; set to 1 if carry occurred
(1)       0 : =40                ST_N:   equ  01000000B          ; set to 1 if result is negative
(1)       0 : =20                ST_Z:   equ  00100000B          ; set to 1 if result is zero
(1)       0 : =10                ST_V:   equ  00010000B          ; set to 1 if result is overflow
(1)       0 : =8                 ST_IE2: equ  00001000B          ; if 1, level 2 interrupt is enabled
(1)       0 : =4                 ST_IE1: equ  00000100B          ; if 1, level 1 interrupt is enabled
(1)       0 :                    ;;; Vector
(1)       0 : =7FF8              VEC_INT3:       equ     7FF8H   ; #INT2 interrupt
(1)       0 : =7FFA              VEC_INT2:       equ     7FFAH   ; #INT2 interrupt
(1)       0 : =7FFC              VEC_INT1:       equ     7FFCH   ; #INT1 interrupt
(1)       0 : =7FFE              VEC_RESET:      equ     7FFEH   ; #RESET vector
(1)       0 :                    ;;; Trap Vector
(1)       0 : =7FDE              VEC_TRAP0:      equ     7FDEH
(1)       0 : =7FDC              VEC_TRAP1:      equ     7FDCH
(1)       0 : =7FDA              VEC_TRAP2:      equ     7FDAH
(1)       0 : =7FD8              VEC_TRAP3:      equ     7FD8H
(1)       0 : =7FD6              VEC_TRAP4:      equ     7FD6H
(1)       0 : =7FD4              VEC_TRAP5:      equ     7FD4H
(1)       0 : =7FD2              VEC_TRAP6:      equ     7FD2H
(1)       0 : =7FD0              VEC_TRAP7:      equ     7FD0H
(1)       0 : =7FCE              VEC_TRAP8:      equ     7FCEH
(1)       0 : =7FCC              VEC_TRAP9:      equ     7FCCH
(1)       0 : =7FCA              VEC_TRAP10:     equ     7FCAH
(1)       0 : =7FC8              VEC_TRAP11:     equ     7FC8H
(1)       0 : =7FC6              VEC_TRAP12:     equ     7FC6H
(1)       0 : =7FC4              VEC_TRAP13:     equ     7FC4H
(1)       0 : =7FC2              VEC_TRAP14:     equ     7FC2H
(1)       0 : =7FC0              VEC_TRAP15:     equ     7FC0H
(1)       0 :                    ;;; System Control and Configuration Registers
(1)       0 : =1010              SCCR0:          equ     1010H
(1)       0 : =40                OSC_POWER:      equ     01000000B
(1)       0 : =1011              SCCR1:          equ     1011H
(1)       0 : =10                AUTO_WAIT_DISABLE:      equ     00010000B
(1)       0 : =1012              SCCR2:          equ     1012H
(1)       0 : =1017              INT1:           equ     1017H
(1)       0 : =1018              INT2:           equ     1018H
(1)       0 : =1019              INT3:           equ     1019H
(1)       0 : =80                INT_FLAG:       equ     10000000B ; INTx Flag 1:transition detected
(1)       0 : =10                INT_DIR:        equ     00010000B ; INTx Direction 1:output 0:input/interrupt
(1)       0 : =8                 INT_DATA:       equ     00001000B ; INTx Data out
(1)       0 : =4                 INT_POLALITY:   equ     00000100B ; INTx Polarity 1:rising 0:falling
(1)       0 : =2                 INT_PRIORITY:   equ     00000010B ; INTx Priority 1:level2 0:level1
(1)       0 : =1                 INT_ENABLE:     equ     00000001B ; INTx Enable 1:enable 0:disable
          0 :
          0 :                    ;;; MC6850 Asynchronous Communication Interface Adapter
          0 : =10F0              ACIA:   equ     10F0H
          0 :                            include "mc6850.inc"
(1)       0 :                    ;;; -*- mode: asm; mode: flyspell-prog; -*-
(1)       0 :                    ;;; MC6850
(1)       0 :                    ;;; Asynchronous Communication Interface Adapter
(1)       0 : =10F0              ACIA_control:   equ     ACIA+0
(1)       0 : =10F0              ACIA_status:    equ     ACIA+0
(1)       0 : =10F1              ACIA_data:      equ     ACIA+1
(1)       0 :                            ;;  Counter Divider Select Bits
(1)       0 : =3                 CDS_gm:         equ     11B             ; Group mask
(1)       0 : =0                 CDS_DIV1_gc:    equ     00000000B       ; /1
(1)       0 : =1                 CDS_DIV16_gc:   equ     00000001B       ; /16
(1)       0 : =2                 CDS_DIV64_gc:   equ     00000010B       ; /64
(1)       0 : =3                 CDS_RESET_gc:   equ     00000011B       ; Master Reset
(1)       0 :                            ;;  Word Select Bits
(1)       0 : =1C                WSB_gm:         equ     00011100B       ; Group mask
(1)       0 : =0                 WSB_7E2_gc:     equ     00000000B       ; 7 Bits + Even Parity + 2 Stop Bits
(1)       0 : =4                 WSB_7O2_gc:     equ     00000100B       ; 7 bits + Odd Parity  + 2 Stop Bits
(1)       0 : =8                 WSB_7E1_gc:     equ     00001000B       ; 7 bits + Even Parity + 1 Stop Bits
(1)       0 : =C                 WSB_7O1_gc:     equ     00001100B       ; 7 bits + Odd Parity  + 1 Stop Bits
(1)       0 : =10                WSB_8N2_gc:     equ     00010000B       ; 8 bits + No Parity   + 2 Stop Bits
(1)       0 : =14                WSB_8N1_gc:     equ     00010100B       ; 8 bits + No Parity   + 1 Stop Bits
(1)       0 : =18                WSB_8E1_gc:     equ     00011000B       ; 8 bits + Even Parity + 1 Stop Bits
(1)       0 : =1C                WSB_8O1_gc:     equ     00011100B       ; 8 bits + Odd Parity  + 1 Stop Bits
(1)       0 :                            ;;  Transmit Control Bits
(1)       0 : =60                TCB_gm:         equ     01100000B       ; Group mask
(1)       0 : =0                 TCB_DI_gc:      equ     00000000B       ; RTS=Low,  Tx Interrupt Disabled
(1)       0 : =20                TCB_EI_gc:      equ     00100000B       ; RTS=Low,  Tx Interrupt Enabled
(1)       0 : =40                TCB_RTS_gc:     equ     01000000B       ; RTS=High, Tx Interrupt Disabled
(1)       0 : =60                TCB_BREAK_gc:   equ     01100000B       ; RTS=Low,  Tx Interrupt Disabled
(1)       0 :                                                    ; Transmit Break Level
(1)       0 : =80                RIEB_bm:        equ     10000000B       ; Receive Interrupt Enable Bit mask
(1)       0 :                    ;;; Status register
(1)       0 : =1                 RDRF_bm:        equ     00000001B       ; Receive Data Register Full
(1)       0 : =2                 TDRE_bm:        equ     00000010B       ; Transmit Data Register Empty
(1)       0 : =4                 DCDF_bm:        equ     00000100B       ; Data Carrier Detect Flag
(1)       0 : =8                 CTSF_bm:        equ     00001000B       ; Clear To Send Flag
(1)       0 : =10                FERR_bm:        equ     00010000B       ; Frame Error Flag
(1)       0 : =20                OVRN_bm:        equ     00100000B       ; Receiver Overrun Flag
(1)       0 : =40                PERR_bm:        equ     01000000B       ; Parity Error Flag
(1)       0 : =80                IRQF_bm:        equ     10000000B       ; Interrupt Request Flag
          0 : =94                RX_INT_TX_NO:   equ     WSB_8N1_gc|RIEB_bm
          0 : =B4                RX_INT_TX_INT:  equ     WSB_8N1_gc|RIEB_bm|TCB_EI_gc
          0 :
       3000 :                            org     3000H
       3000 : =80                rx_queue_size:  equ     128
       3000 :                    rx_queue:       .block  rx_queue_size
       3080 : =80                tx_queue_size:  equ     128
       3080 :                    tx_queue:       .block  tx_queue_size
       3100 :
       3100 :                    ;;; Internal registers
         D0 :                            org     00D0H
         D0 : =CF                stack:  equ     $-1     ; TMS370's SP is pre-increment/post-decrement
         D0 :
       7FFC :                            org     VEC_INT1
       7FFC : 21 19                      .word   isr_int1
       7FFE :
       7FFE :                            org     VEC_RESET
       7FFE : 20 00                      .word   initialize
       8000 :
       7FC0 :                            org     VEC_TRAP15
       7FC0 : 7F C0                      .word   VEC_TRAP15
       7FC2 :
       2000 :                            org     2000H
       2000 :                    initialize:
       2000 : 52 CF                      mov     #stack, B
       2002 : FD                         ldsp
       2003 : 88 30 00 03                movw    #rx_queue, R3
       2007 : 52 80                      mov     #rx_queue_size, B
       2009 : 8E 20 A7                   call    queue_init
       200C : 88 30 80 03                movw    #tx_queue, R3
       2010 : 52 80                      mov     #tx_queue_size, B
       2012 : 8E 20 A7                   call    queue_init
       2015 :                    ;;; initialize ACIA
       2015 : F7 03 F0                   mov     #CDS_RESET_gc, ACIA_control     ; Master reset
       2018 : F7 94 F0                   mov     #RX_INT_TX_NO, ACIA_control
       201B : F7 01 F2                   mov     #1, ACIA+2        ; INT1 for Rx/Tx
       201E : F7 01 17                   mov     #INT_ENABLE, INT1 ; enable falling #INT1
       2021 : F0 0C                      eint
       2023 :
       2023 :                    loop:
       2023 : 8E 20 85                   call    getchar
       2026 : 07 FB                      jnc     loop
       2028 : B0                         tst     A
       2029 : 02 15                      jz      halt_to_system
       202B : C0                         mov     A, B
       202C : 8E 20 96                   call    putchar        echo
       202F : 8E 20 41                   call    putspace
       2032 : 8E 20 4E                   call    put_hex8       print in hex
       2035 : 8E 20 41                   call    putspace
       2038 : 8E 20 6A                   call    put_bin8       print in binary
       203B : 8E 20 45                   call    newline
       203E : 00 E3                      jmp     loop
       2040 :                    halt_to_system:
       2040 : E0                         trap    15
       2041 :
       2041 :                    ;;; Put sapce
       2041 :                    ;;; @clobber A
       2041 :                    putspace:
       2041 : 22 20                      mov     #' ', A
       2043 : 00 51                      jmp     putchar
       2045 :
       2045 :                    ;;; Put newline
       2045 :                    ;;; @clobber A
       2045 :                    newline:
       2045 : 22 0D                      mov     #0DH, A
       2047 : 8E 20 96                   call    putchar
       204A : 22 0A                      mov     #0AH, A
       204C : 00 48                      jmp     putchar
       204E :
       204E :                    ;;; Print uint8_t in hex
       204E :                    ;;; @param B uint8_t value to be printed in hex.
       204E :                    ;;; @clobber A
       204E :                    put_hex8:
       204E : 22 30                      mov     #'0', A
       2050 : 8E 20 96                   call    putchar
       2053 : 22 78                      mov     #'x', A
       2055 : 8E 20 96                   call    putchar
       2058 : 62                         mov     B, A
       2059 : B7                         swap    A
       205A : 8E 20 5E                   call    put_hex4
       205D : 62                         mov     B, A
       205E :                    put_hex4:
       205E : 23 0F                      and     #0FH, A
       2060 : 2D 0A                      cmp     #10, A
       2062 : 09 02                      jl      put_hex8_dec
       2064 : 28 07                      add     #'A'-10-'0', A
       2066 :                    put_hex8_dec:
       2066 : 28 30                      add     #'0', A
       2068 : 00 2C                      jmp     putchar
       206A :
       206A :                    ;;; Print uint8_t in binary
       206A :                    ;;; @param B uint8_t value to be printed in binary.
       206A :                    ;;; @clobber A B
       206A :                    put_bin8:
       206A : 22 30                      mov     #'0', A
       206C : 8E 20 96                   call    putchar
       206F : 22 62                      mov     #'b', A
       2071 : 8E 20 96                   call    putchar
       2074 : 8E 20 77                   call    put_bin4
       2077 :                    put_bin4:
       2077 : 8E 20 7A                   call    put_bin2
       207A :                    put_bin2:
       207A : 8E 20 7D                   call    put_bin1
       207D :                    put_bin1:
       207D : 22 30                      mov     #'0', A
       207F : CF                         rlc     B
       2080 : 07 14                      jnc     putchar         ; MSB=0
       2082 : B3                         inc     A               ; MSB=1
       2083 : 00 11                      jmp     putchar
       2085 :
       2085 :                    ;;; Get character
       2085 :                    ;;; @return A
       2085 :                    ;;; @return ST.C 0 if no character
       2085 :                    ;;; @clobber R2:R3
       2085 :                    getchar:
       2085 : FB                         push    st
       2086 : 88 30 00 03                movw    #rx_queue, R3
       208A : F0 00                      dint
       208C : 8E 20 EF                   call    queue_remove
       208F : 07 03                      jnc     getchar_empty
       2091 : FC                         pop     st
       2092 : F8                         setc                    ; ST.C=1
       2093 : F9                         rts
       2094 :                    getchar_empty:
       2094 : FC                         pop     st              ; ST.C=0
       2095 : F9                         rts
       2096 :
       2096 :                    ;;; Put character
       2096 :                    ;;; @param A
       2096 :                    ;;; @clobber R2:R3
       2096 :                    putchar:
       2096 : 88 30 80 03                movw    #tx_queue, R3
       209A : F0 00                      dint
       209C : 8E 20 BD                   call    queue_add
       209F : 07 F5                      jnc     putchar
       20A1 : F7 B4 F0                   mov     #RX_INT_TX_INT, ACIA_control ; enable Tx interrupt
       20A4 : F0 0C                      eint
       20A6 : F9                         rts
       20A7 :
       20A7 :                            include "queue.inc"
(1)    20A7 :                    ;;; -*- mode: asm; mode: flyspell-prog; -*-
(1)    20A7 :                    ;;; [queue] queue structure
(1)    20A7 : =0                 queue_len:      equ     0       ; queue length
(1)    20A7 : =1                 queue_size:     equ     1       ; buffer size
(1)    20A7 : =2                 queue_put:      equ     2       ; queue put index
(1)    20A7 : =3                 queue_get:      equ     3       ; queue get index
(1)    20A7 : =4                 queue_buf:      equ     4       ; buffer start offset
(1)    20A7 :
(1)    20A7 :                    ;;; [queue] Initialize queue
(1)    20A7 :                    ;;; @param R2:R3 queue work space pointer
(1)    20A7 :                    ;;; @param B queue work space size
(1)    20A7 :                    ;;; @clobber A B R2:R3
(1)    20A7 :                    queue_init:
(1)    20A7 : B5                         clr     A
(1)    20A8 : 9B 03                      mov     A, @R3          ; queue_len
(1)    20AA : 62                         mov     B, A
(1)    20AB : 2A 04                      sub     #queue_buf, A
(1)    20AD : D3 03                      inc     R3
(1)    20AF : 9B 03                      mov     A, @R3          ; queue_size
(1)    20B1 : 5A 02                      sub     #queue_put, B   ; offset queue_len and queue_size
(1)    20B3 : D3 03                      inc     R3              ; R2:R3=&queue_put
(1)    20B5 : B5                         clr     A
(1)    20B6 :                    queue_init_loop:
(1)    20B6 : 9B 03                      mov     A, @R3
(1)    20B8 : D3 03                      inc     R3
(1)    20BA : CA FA                      djnz    B, queue_init_loop
(1)    20BC : F9                         rts
(1)    20BD :
(1)    20BD :                    ;;; [queue] Add an element to queue
(1)    20BD :                    ;;; @param R2:R3 queue work space pointer
(1)    20BD :                    ;;; @param A an element
(1)    20BD :                    ;;; @return ST.C 0 if queue is full
(1)    20BD :                    ;;; @clobber R2:R3
(1)    20BD :                    queue_add:
(1)    20BD : B8                         push    A
(1)    20BE : 9A 03                      mov     @R3, A          ; A=queue_len
(1)    20C0 : F4 ED 01 03                cmp     queue_size(R3), A
(1)    20C4 : 09 02                      jl      queue_add_element
(1)    20C6 : B9                         pop     A               ; ST.C=0
(1)    20C7 : F9                         rts
(1)    20C8 :                    queue_add_element:
(1)    20C8 : B3                         inc     A
(1)    20C9 : 9B 03                      mov     A, @R3          ; queue_len++
(1)    20CB : F4 EA 02 03                mov     queue_put(R3), A
(1)    20CF : 28 04                      add     #queue_buf, A
(1)    20D1 : D8 03                      push    R3              ; save pointer
(1)    20D3 : 48 00 03                   add     A, R3           ; R2:R3=&queue_buf[queue_put]
(1)    20D6 : F1 FF                      mov     -1(SP), A       ; element
(1)    20D8 : 9B 03                      mov     A, @R3          ; store element
(1)    20DA : D9 03                      pop     R3              ; restore pointer
(1)    20DC : F4 EA 02 03                mov     queue_put(R3), A
(1)    20E0 : B3                         inc     A
(1)    20E1 : F4 ED 01 03                cmp     queue_size(R3), A
(1)    20E5 : 09 01                      jl      queue_add_return
(1)    20E7 : B5                         clr     A               ; wraparound
(1)    20E8 :                    queue_add_return:
(1)    20E8 : F4 EB 02 03                mov     A, queue_put(R3) ; update queue_put
(1)    20EC : B9                         pop     A
(1)    20ED : F8                         setc                    ; ST.C=1
(1)    20EE : F9                         rts
(1)    20EF :
(1)    20EF :                    ;;; [queue] Remove an element from queue
(1)    20EF :                    ;;; @param R2:R3 queue work space pointer
(1)    20EF :                    ;;; @return A an element
(1)    20EF :                    ;;; @return ST.C 0 if queue is empty
(1)    20EF :                    queue_remove:
(1)    20EF : 9A 03                      mov     @R3, A          ; A=queue_len, ST.C=0
(1)    20F1 : 02 25                      jz      queue_remove_end
(1)    20F3 :                    queue_remove_elem:
(1)    20F3 : B2                         dec     A
(1)    20F4 : 9B 03                      mov     A, @R3          ; queue_len--
(1)    20F6 : F4 EA 03 03                mov     queue_get(R3), A
(1)    20FA : 28 04                      add     #queue_buf, A
(1)    20FC : D8 03                      push    R3              ; save pointer
(1)    20FE : 48 00 03                   add     A, R3           ; R2:R3=&queue_buf[queue_get]
(1)    2101 : 9A 03                      mov     @R3, A          ; remove element
(1)    2103 : D9 03                      pop     R3              ; restore pointer
(1)    2105 : B8                         push    A               ; save element
(1)    2106 : F4 EA 03 03                mov     queue_get(R3), A
(1)    210A : B3                         inc     A
(1)    210B : F4 ED 01 03                cmp     queue_size(R3), A
(1)    210F : 09 01                      jl      queue_remove_return
(1)    2111 : B5                         clr     A               ; wraparound
(1)    2112 :                    queue_remove_return:
(1)    2112 : F4 EB 03 03                mov     A, queue_get(R3)
(1)    2116 : B9                         pop     A               ; restore element
(1)    2117 : F8                         setc
(1)    2118 :                    queue_remove_end:
(1)    2118 : F9                         rts
       2119 :
       2119 :                    isr_int1:
       2119 : A3 7F 17                   and     #~INT_FLAG & 0FFH, INT1 ; clear INT1_FLAG
       211C : A7 80 F0 2B                btjz    #IRQF_bm, ACIA_status, isr_int1_return
       2120 : B8                         push    A
       2121 : D8 02                      push    R2
       2123 : D8 03                      push    R3
       2125 : A7 01 F0 09                btjz    #RDRF_bm, ACIA_status, isr_tx
       2129 : 80 F1                      mov     ACIA_data, A
       212B : 88 30 00 03                movw    #rx_queue, R3
       212F : 8E 20 BD                   call    queue_add
       2132 :                    isr_tx:
       2132 : A7 02 F0 10                btjz    #TDRE_bm, ACIA_status, isr_int1_exit
       2136 : 88 30 80 03                movw    #tx_queue, R3
       213A : 8E 20 EF                   call    queue_remove
       213D : 07 04                      jnc     isr_tx_empty
       213F : 21 F1                      mov     A, ACIA_data    ; send character
       2141 : 00 03                      jmp     isr_int1_exit
       2143 :                    isr_tx_empty:
       2143 : F7 94 F0                   mov     #RX_INT_TX_NO, ACIA_control ; disable Tx interrupt
       2146 :                    isr_int1_exit:
       2146 : D9 03                      pop     R3
       2148 : D9 02                      pop     R2
       214A : B9                         pop     A
       214B :                    isr_int1_return:
       214B : FA                         rti
