          0 :                    ;;; -*- mode: asm; mode: flyspell-prog; -*-
          0 :                            include "tms370.inc"
(1)       0 :                    ;;; -*- mode: asm; mode: flyspell-prog; -*-
(1)       0 :                    ;;; TMS370
(1)       0 :                            cpu     tms370
(1)       0 :                    ;;; Status Register
(1)       0 : =80                ST_C:   equ  10000000B          ; set to 1 if carry occurred
(1)       0 : =40                ST_N:   equ  01000000B          ; set to 1 if result is negative
(1)       0 : =20                ST_Z:   equ  00100000B          ; set to 1 if result is zero
(1)       0 : =10                ST_V:   equ  00010000B          ; set to 1 if result is overflow
(1)       0 : =8                 ST_IE2: equ  00001000B          ; if 1, level 2 interrupt is enabled
(1)       0 : =4                 ST_IE1: equ  00000100B          ; if 1, level 1 interrupt is enabled
(1)       0 :                    ;;; Vector
(1)       0 : =7FF8              VEC_INT3:       equ     7FF8H   ; #INT2 interrupt
(1)       0 : =7FFA              VEC_INT2:       equ     7FFAH   ; #INT2 interrupt
(1)       0 : =7FFC              VEC_INT1:       equ     7FFCH   ; #INT1 interrupt
(1)       0 : =7FFE              VEC_RESET:      equ     7FFEH   ; #RESET vector
(1)       0 :                    ;;; Trap Vector
(1)       0 : =7FDE              VEC_TRAP0:      equ     7FDEH
(1)       0 : =7FDC              VEC_TRAP1:      equ     7FDCH
(1)       0 : =7FDA              VEC_TRAP2:      equ     7FDAH
(1)       0 : =7FD8              VEC_TRAP3:      equ     7FD8H
(1)       0 : =7FD6              VEC_TRAP4:      equ     7FD6H
(1)       0 : =7FD4              VEC_TRAP5:      equ     7FD4H
(1)       0 : =7FD2              VEC_TRAP6:      equ     7FD2H
(1)       0 : =7FD0              VEC_TRAP7:      equ     7FD0H
(1)       0 : =7FCE              VEC_TRAP8:      equ     7FCEH
(1)       0 : =7FCC              VEC_TRAP9:      equ     7FCCH
(1)       0 : =7FCA              VEC_TRAP10:     equ     7FCAH
(1)       0 : =7FC8              VEC_TRAP11:     equ     7FC8H
(1)       0 : =7FC6              VEC_TRAP12:     equ     7FC6H
(1)       0 : =7FC4              VEC_TRAP13:     equ     7FC4H
(1)       0 : =7FC2              VEC_TRAP14:     equ     7FC2H
(1)       0 : =7FC0              VEC_TRAP15:     equ     7FC0H
(1)       0 :                    ;;; System Control and Configuration Registers
(1)       0 : =1010              SCCR0:          equ     1010H
(1)       0 : =1011              SCCR1:          equ     1011H
(1)       0 : =1012              SCCR2:          equ     1012H
(1)       0 : =1017              INT1:           equ     1017H
(1)       0 : =1018              INT2:           equ     1018H
(1)       0 : =1019              INT3:           equ     1019H
(1)       0 : =80                INT_FLAG:       equ     10000000B ; INTx Flag
(1)       0 : =4                 INT_POLALITY:   equ     00000100B ; INTx Polarity 1:rising 0:falling
(1)       0 : =2                 INT_PRIORITY:   equ     00000010B ; INTx Priority 1:level2 0:level1
(1)       0 : =1                 INT_ENABLE:     equ     00000001B ; INTx Enable 1:enable 0:disable
          0 :
          0 :                    ;;; MC6850 Asynchronous Communication Interface Adapter
          0 : =10F0              ACIA:   equ     10F0H
          0 :                            include "mc6850.inc"
(1)       0 :                    ;;; -*- mode: asm; mode: flyspell-prog; -*-
(1)       0 :                    ;;; MC6850
(1)       0 :                    ;;; Asynchronous Communication Interface Adapter
(1)       0 : =10F0              ACIA_control:   equ     ACIA+0
(1)       0 : =10F0              ACIA_status:    equ     ACIA+0
(1)       0 : =10F1              ACIA_data:      equ     ACIA+1
(1)       0 :                            ;;  Counter Divider Select Bits
(1)       0 : =3                 CDS_gm:         equ     11B             ; Group mask
(1)       0 : =0                 CDS_DIV1_gc:    equ     00000000B       ; /1
(1)       0 : =1                 CDS_DIV16_gc:   equ     00000001B       ; /16
(1)       0 : =2                 CDS_DIV64_gc:   equ     00000010B       ; /64
(1)       0 : =3                 CDS_RESET_gc:   equ     00000011B       ; Master Reset
(1)       0 :                            ;;  Word Select Bits
(1)       0 : =1C                WSB_gm:         equ     00011100B       ; Group mask
(1)       0 : =0                 WSB_7E2_gc:     equ     00000000B       ; 7 Bits + Even Parity + 2 Stop Bits
(1)       0 : =4                 WSB_7O2_gc:     equ     00000100B       ; 7 bits + Odd Parity  + 2 Stop Bits
(1)       0 : =8                 WSB_7E1_gc:     equ     00001000B       ; 7 bits + Even Parity + 1 Stop Bits
(1)       0 : =C                 WSB_7O1_gc:     equ     00001100B       ; 7 bits + Odd Parity  + 1 Stop Bits
(1)       0 : =10                WSB_8N2_gc:     equ     00010000B       ; 8 bits + No Parity   + 2 Stop Bits
(1)       0 : =14                WSB_8N1_gc:     equ     00010100B       ; 8 bits + No Parity   + 1 Stop Bits
(1)       0 : =18                WSB_8E1_gc:     equ     00011000B       ; 8 bits + Even Parity + 1 Stop Bits
(1)       0 : =1C                WSB_8O1_gc:     equ     00011100B       ; 8 bits + Odd Parity  + 1 Stop Bits
(1)       0 :                            ;;  Transmit Control Bits
(1)       0 : =60                TCB_gm:         equ     01100000B       ; Group mask
(1)       0 : =0                 TCB_DI_gc:      equ     00000000B       ; RTS=Low,  Tx Interrupt Disabled
(1)       0 : =20                TCB_EI_gc:      equ     00100000B       ; RTS=Low,  Tx Interrupt Enabled
(1)       0 : =40                TCB_RTS_gc:     equ     01000000B       ; RTS=High, Tx Interrupt Disabled
(1)       0 : =60                TCB_BREAK_gc:   equ     01100000B       ; RTS=Low,  Tx Interrupt Disabled
(1)       0 :                                                    ; Transmit Break Level
(1)       0 : =80                RIEB_bm:        equ     10000000B       ; Receive Interrupt Enable Bit mask
(1)       0 :                    ;;; Status register
(1)       0 : =1                 RDRF_bm:        equ     00000001B       ; Receive Data Register Full
(1)       0 : =2                 TDRE_bm:        equ     00000010B       ; Transmit Data Register Empty
(1)       0 : =4                 DCDF_bm:        equ     00000100B       ; Data Carrier Detect Flag
(1)       0 : =8                 CTSF_bm:        equ     00001000B       ; Clear To Send Flag
(1)       0 : =10                FERR_bm:        equ     00010000B       ; Frame Error Flag
(1)       0 : =20                OVRN_bm:        equ     00100000B       ; Receiver Overrun Flag
(1)       0 : =40                PERR_bm:        equ     01000000B       ; Parity Error Flag
(1)       0 : =80                IRQF_bm:        equ     10000000B       ; Interrupt Request Flag
          0 : =94                RX_INT_TX_NO:   equ     WSB_8N1_gc|RIEB_bm
          0 : =B4                RX_INT_TX_INT:  equ     WSB_8N1_gc|RIEB_bm|TCB_EI_gc
          0 :
       3000 :                            org     3000H
       3000 : =80                rx_queue_size:  equ     128
       3000 :                    rx_queue:       .block  rx_queue_size
       3080 : =80                tx_queue_size:  equ     128
       3080 :                    tx_queue:       .block  tx_queue_size
       3100 :
       3100 :                    ;;; Internal registers
         D0 :                            org     00D0H
         D0 : =CF                stack:  equ     $-1     ; TMS370's SP is pre-increment/post-decrement
         D0 :
       7FF8 :                            org     VEC_INT3
       7FF8 : 21 20                      .word   isr_int3
       7FFA :
       7FFE :                            org     VEC_RESET
       7FFE : 20 00                      .word   initialize
       8000 :
       7FC0 :                            org     VEC_TRAP15
       7FC0 : 7F C0                      .word   VEC_TRAP15
       7FC2 :
       2000 :                            org     2000H
       2000 :                    initialize:
       2000 : 52 CF                      mov     #stack, B
       2002 : FD                         ldsp
       2003 : 88 30 00 03                movw    #rx_queue, R3
       2007 : 52 80                      mov     #rx_queue_size, B
       2009 : 8E 20 A8                   call    queue_init
       200C : 88 30 80 03                movw    #tx_queue, R3
       2010 : 52 80                      mov     #tx_queue_size, B
       2012 : 8E 20 A8                   call    queue_init
       2015 :                    ;;; initialize ACIA
       2015 : F7 03 F0                   mov     #CDS_RESET_gc, ACIA_control     ; Master reset
       2018 : F7 94 F0                   mov     #RX_INT_TX_NO, ACIA_control
       201B : F7 03 F2                   mov     #3, ACIA+2                      ; #INT3 for Rx/Tx
       201E : F7 01 19                   mov     #INT_ENABLE, INT3               ; enable #INT3
       2021 :
       2021 :                    loop:
       2021 : 8E 20 83                   call    getchar
       2024 : 07 FB                      jnc     loop
       2026 : B0                         tst     A
       2027 : 02 15                      jz      halt_to_system
       2029 : C0                         mov     A, B
       202A : 8E 20 95                   call    putchar        echo
       202D : 8E 20 3F                   call    putspace
       2030 : 8E 20 4C                   call    put_hex8       print in hex
       2033 : 8E 20 3F                   call    putspace
       2036 : 8E 20 68                   call    put_bin8       print in binary
       2039 : 8E 20 43                   call    newline
       203C : 00 E3                      jmp     loop
       203E :                    halt_to_system:
       203E : E0                         trap    15
       203F :
       203F :                    ;;; Put sapce
       203F :                    ;;; @clobber A
       203F :                    putspace:
       203F : 22 20                      mov     #' ', A
       2041 : 00 52                      jmp     putchar
       2043 :
       2043 :                    ;;; Put newline
       2043 :                    ;;; @clobber A
       2043 :                    newline:
       2043 : 22 0D                      mov     #0DH, A
       2045 : 8E 20 95                   call    putchar
       2048 : 22 0A                      mov     #0AH, A
       204A : 00 49                      jmp     putchar
       204C :
       204C :                    ;;; Print uint8_t in hex
       204C :                    ;;; @param B uint8_t value to be printed in hex.
       204C :                    ;;; @clobber A
       204C :                    put_hex8:
       204C : 22 30                      mov     #'0', A
       204E : 8E 20 95                   call    putchar
       2051 : 22 78                      mov     #'x', A
       2053 : 8E 20 95                   call    putchar
       2056 : 62                         mov     B, A
       2057 : B7                         swap    A
       2058 : 8E 20 5C                   call    put_hex4
       205B : 62                         mov     B, A
       205C :                    put_hex4:
       205C : 23 0F                      and     #0FH, A
       205E : 2D 0A                      cmp     #10, A
       2060 : 09 02                      jl      put_hex8_dec
       2062 : 28 07                      add     #'A'-10-'0', A
       2064 :                    put_hex8_dec:
       2064 : 28 30                      add     #'0', A
       2066 : 00 2D                      jmp     putchar
       2068 :
       2068 :                    ;;; Print uint8_t in binary
       2068 :                    ;;; @param B uint8_t value to be printed in binary.
       2068 :                    ;;; @clobber A B
       2068 :                    put_bin8:
       2068 : 22 30                      mov     #'0', A
       206A : 8E 20 95                   call    putchar
       206D : 22 62                      mov     #'b', A
       206F : 8E 20 95                   call    putchar
       2072 : 8E 20 75                   call    put_bin4
       2075 :                    put_bin4:
       2075 : 8E 20 78                   call    put_bin2
       2078 :                    put_bin2:
       2078 : 8E 20 7B                   call    put_bin1
       207B :                    put_bin1:
       207B : 22 30                      mov     #'0', A
       207D : CF                         rlc     B
       207E : 07 15                      jnc     putchar         ; MSB=0
       2080 : B3                         inc     A               ; MSB=1
       2081 : 00 12                      jmp     putchar
       2083 :
       2083 :                    ;;; Get character
       2083 :                    ;;; @return A
       2083 :                    ;;; @return ST.C 0 if no character
       2083 :                    ;;; @clobber R2:R3
       2083 :                    getchar:
       2083 : 88 30 00 03                movw    #rx_queue, R3
       2087 : F0 00                      dint
       2089 : 8E 20 F3                   call    queue_remove
       208C : 07 03                      jnc     getchar_empty
       208E : F0 0C                      eint                    ; ST.C=1
       2090 : F9                         rts
       2091 :                    getchar_empty:
       2091 : F0 0C                      eint
       2093 : B0                         clrc                    ; ST.C=0
       2094 : F9                         rts
       2095 :
       2095 :                    ;;; Put character
       2095 :                    ;;; @param A
       2095 :                    ;;; @clobber R2:R3
       2095 :                    putchar:
       2095 : F0 0C                      eint
       2097 : 88 30 80 03                movw    #tx_queue, R3
       209B : F0 00                      dint
       209D : 8E 20 BE                   call    queue_add
       20A0 : 07 F3                      jnc     putchar
       20A2 : F0 0C                      eint
       20A4 : F7 B4 F0                   mov     #RX_INT_TX_INT, ACIA_control ; enable Tx interrupt
       20A7 : F9                         rts
       20A8 :
       20A8 :                            include "queue.inc"
(1)    20A8 :
(1)    20A8 :                            ;;; [queue] queue structure
(1)    20A8 : =0                 queue_len:      equ     0       ; queue length
(1)    20A8 : =1                 queue_size:     equ     1       ; buffer size
(1)    20A8 : =2                 queue_put:      equ     2       ; queue put index
(1)    20A8 : =3                 queue_get:      equ     3       ; queue get index
(1)    20A8 : =4                 queue_buf:      equ     4       ; buffer start offset
(1)    20A8 :
(1)    20A8 :                    ;;; [queue] Initialize queue
(1)    20A8 :                    ;;; @param R2:R3 queue work space pointer
(1)    20A8 :                    ;;; @param B queue work space size
(1)    20A8 :                    ;;; @clobber A B R2:R3
(1)    20A8 :                    queue_init:
(1)    20A8 : B5                         clr     A
(1)    20A9 : 9B 03                      mov     A, @R3          ; queue_len
(1)    20AB : 62                         mov     B, A
(1)    20AC : 2A 04                      sub     #queue_buf, A
(1)    20AE : D3 03                      inc     R3
(1)    20B0 : 9B 03                      mov     A, @R3          ; queue_size
(1)    20B2 : 5A 02                      sub     #queue_put, B   ; offset queue_len and queue_size
(1)    20B4 : D3 03                      inc     R3              ; R2:R3=&queue_put
(1)    20B6 : B5                         clr     A
(1)    20B7 :                    queue_init_loop:
(1)    20B7 : 9B 03                      mov     A, @R3
(1)    20B9 : D3 03                      inc     R3
(1)    20BB : CA FA                      djnz    B, queue_init_loop
(1)    20BD : F9                         rts
(1)    20BE :
(1)    20BE :                    ;;; [queue] Add an element to queue
(1)    20BE :                    ;;; @param R2:R3 queue work space pointer
(1)    20BE :                    ;;; @param A an element
(1)    20BE :                    ;;; @return ST.C 0 if queue is full
(1)    20BE :                    ;;; @clobber R2:R3
(1)    20BE :                    queue_add:
(1)    20BE : B8                         push    A
(1)    20BF : 9A 03                      mov     @R3, A          ; A=queue_len
(1)    20C1 : D3 03                      inc     R3              ; R2:R3=&queue_size
(1)    20C3 : 9D 03                      cmp     @R3, A
(1)    20C5 : 09 02                      jl      queue_add_element
(1)    20C7 : B9                         pop     A               ; ST.C=0
(1)    20C8 : F9                         rts
(1)    20C9 :                    queue_add_element:
(1)    20C9 : B3                         inc     A
(1)    20CA : D2 03                      dec     R3
(1)    20CC : 9B 03                      mov     A, @R3          ; queue_len++
(1)    20CE : B9                         pop     A
(1)    20CF : 78 02 03                   add     #queue_put-queue_len, R3 ; R2:R3=&queue_put
(1)    20D2 : D8 03                      push    R3
(1)    20D4 : B8                         push    A
(1)    20D5 : 9A 03                      mov     @R3, A          ; A=queue_put
(1)    20D7 : 28 02                      add     #queue_buf-queue_put, A
(1)    20D9 : 48 00 03                   add     A, R3           ; R2:R3=&queue[queue_put]
(1)    20DC : B9                         pop     A
(1)    20DD : 9B 03                      mov     A, @R3          ; store element
(1)    20DF : D9 03                      pop     R3              ; R2:R3=&queue_put
(1)    20E1 : B8                         push    A
(1)    20E2 : 9A 03                      mov     @R3, A
(1)    20E4 : B3                         inc     A
(1)    20E5 : D2 03                      dec     R3              ; R2:R3=&queue_size
(1)    20E7 : 9D 03                      cmp     @R3, A
(1)    20E9 : 09 01                      jl      queue_add_return
(1)    20EB : B5                         clr     A               ; wraparound
(1)    20EC :                    queue_add_return:
(1)    20EC : D3 03                      inc     R3              ; R2:R3=&queue_put
(1)    20EE : 9B 03                      mov     A, @R3          ; update queue_put
(1)    20F0 : B9                         pop     A
(1)    20F1 : F8                         setc                    ; ST.C=1
(1)    20F2 : F9                         rts
(1)    20F3 :
(1)    20F3 :                    ;;; [queue] Remove an element from queue
(1)    20F3 :                    ;;; @param R2:R3 queue work space pointer
(1)    20F3 :                    ;;; @return A an element
(1)    20F3 :                    ;;; @return ST.C 0 if queue is empty
(1)    20F3 :                    queue_remove:
(1)    20F3 : 9A 03                      mov     @R3, A          ; A=queue_len
(1)    20F5 : 06 02                      jnz     queue_remove_elem
(1)    20F7 : B0                         clrc
(1)    20F8 : F9                         rts
(1)    20F9 :                    queue_remove_elem:
(1)    20F9 : B2                         dec     A
(1)    20FA : 9B 03                      mov     A, @R3          ; queue_len--
(1)    20FC : 78 03 03                   add     #queue_get-queue_len, R3 ; R2:R3=&queue_get
(1)    20FF : D8 03                      push    R3
(1)    2101 : 9A 03                      mov     @R3, A          ; A=queue_get
(1)    2103 : 28 01                      add     #queue_buf-queue_get, A
(1)    2105 : 48 00 03                   add     A, R3           ; R2:R3=&queue_buf[queue_get]
(1)    2108 : 9A 03                      mov     @R3, A          ; remove element
(1)    210A : D9 03                      pop     R3              ; R2:R3=&queue_get
(1)    210C : B8                         push    A
(1)    210D : 9A 03                      mov     @R3, A
(1)    210F : B3                         inc     A
(1)    2110 : 7A 02 03                   sub     #queue_get-queue_size, R3
(1)    2113 : 9D 03                      cmp     @R3, A
(1)    2115 : 09 01                      jl      queue_remove_return
(1)    2117 : B5                         clr     A               ; wraparound
(1)    2118 :                    queue_remove_return:
(1)    2118 : 78 02 03                   add     #queue_get-queue_size, R3
(1)    211B : 9B 03                      mov     A, @R3          ; update queue_get
(1)    211D : B9                         pop     A
(1)    211E : F8                         setc
(1)    211F : F9                         rts
       2120 :
       2120 :                    isr_int3:
       2120 : A7 80 F0 2B                btjz    #IRQF_bm, ACIA_status, isr_int3_return
       2124 : B8                         push    A
       2125 : D8 02                      push    R2
       2127 : D8 03                      push    R3
       2129 : A7 01 F0 09                btjz    #RDRF_bm, ACIA_status, isr_tx
       212D : 80 F1                      mov     ACIA_data, A
       212F : 88 30 00 03                movw    #rx_queue, R3
       2133 : 8E 20 BE                   call    queue_add
       2136 :                    isr_tx:
       2136 : A7 02 F0 10                btjz    #TDRE_bm, ACIA_status, isr_int3_exit
       213A : 88 30 80 03                movw    #tx_queue, R3
       213E : 8E 20 F3                   call    queue_remove
       2141 : 07 04                      jnc     isr_tx_empty
       2143 : 21 F1                      mov     A, ACIA_data    ; send character
       2145 : 00 03                      jmp     isr_int3_exit
       2147 :                    isr_tx_empty:
       2147 : F7 94 F0                   mov     #RX_INT_TX_NO, ACIA_control ; disable Tx interrupt
       214A :                    isr_int3_exit:
       214A : D9 03                      pop     R3
       214C : D9 02                      pop     R2
       214E : B9                         pop     A
       214F :                    isr_int3_return:
       214F : FA                         rti
