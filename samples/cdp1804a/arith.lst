          0 :                    ;;; -*- mode: asm; mode: flyspell-prog; -*-
          0 :                            cpu     1804A
          0 :                            option  "smart-branch", "on"
          0 :                            include "cdp1802.inc"
(1)       0 :                    ;;; -*- mode: asm; mode: flyspell-prog; -*-
(1)       0 :
(1)       0 :                    ;;; CDP1802 register alias
(1)       0 : =0                 R0:     equ     0
(1)       0 : =1                 R1:     equ     1
(1)       0 : =2                 R2:     equ     2
(1)       0 : =3                 R3:     equ     3
(1)       0 : =4                 R4:     equ     4
(1)       0 : =5                 R5:     equ     5
(1)       0 : =6                 R6:     equ     6
(1)       0 : =7                 R7:     equ     7
(1)       0 : =8                 R8:     equ     8
(1)       0 : =9                 R9:     equ     9
(1)       0 : =A                 R10:    equ     10
(1)       0 : =B                 R11:    equ     11
(1)       0 : =C                 R12:    equ     12
(1)       0 : =D                 R13:    equ     13
(1)       0 : =E                 R14:    equ     14
(1)       0 : =F                 R15:    equ     15
(1)       0 :
(1)       0 :                    ;;; Transfer locations
(1)       0 : =0                 ORG_RESET:      equ     0000H   ; Reset transfer location
          0 :
          0 :                            org     ORG_RESET
          0 : 71                         dis                     ; disable interrupt
          1 : 00                         dc      X'00'           ; X:P=0:0
          2 : 30 04                      br      scrt_init
          4 :                            include "scrt.inc"
(1)       4 :                    ;;; -*- mode: asm; mode: flyspell-prog; -*-
(1)       4 :
(1)       4 :                    ;;; Standard Call and Return Technique
(1)       4 :                    ;;; R0: DMA pointer
(1)       4 :                    ;;; R1: Program counter for Interrupt routine
(1)       4 :                    ;;; R2: Stack pointer
(1)       4 :                    ;;; R3: Program counter
(1)       4 :                    ;;; R4: Link register, pointer to the return location and arguments
(1)       4 :                    ;;;     passed by the calling program
(1)       4 :
(1)       4 :                    ;;; Call subroutine
(1)       4 :                    ;;;   SCAL R4, subroutine
(1)       4 :                    ;;;   DC   arguments...
(1)       4 :                    ;;; Subroutine return
(1)       4 :                    ;;;   SRET R4
(1)       4 :                    ;;; Return from interrupt
(1)       4 :                    ;;;   SEP R1
(1)       4 :
(1)       4 :                    ;;; Initialize for SCRT, P=0
(1)       4 :                    ;;; @param P!=3
(1)       4 :                    ;;; @param stack top address of stack
(1)       4 :                    ;;; @param main start address of main routine
(1)       4 :                    ;;; @return P=3
(1)       4 :                    ;;; @return R1=scrt_isr
(1)       4 :                    ;;; @return R2=stack
(1)       4 :                    ;;; @return R3=main
(1)       4 :                    ;;; @clobber D, R15
(1)       4 :                    scrt_init:
(1)       4 : 68 C3 00 09                rldi    R3, scrt_start
(1)       8 : D3                         sep     R3              ; P=3
(1)       9 :                    scrt_start:
(1)       9 : 68 C1 00 1E                rldi    R1, scrt_isr    ; setup interrupt
(1)       D : E2                         sex     R2
(1)       E : 68 C2 0F FF                rldi    R2, stack       ; setup stack
(1)      12 : C0 10 00                   br      main            ; goto main with P=3
(1)      15 :
(1)      15 :                    ;;; Interrupt exit entry P=1
(1)      15 :                    ;;;  (Come here by SEP R1)
(1)      15 :                    scrt_isr_exit:
(1)      15 : 60                         irx
(1)      16 : 68 63                      rlxa    R3              ; pop program counter R3
(1)      18 : 68 6F                      rlxa    R15             ; pop scratch pad register R15
(1)      1A : 72                         ldxa                    ; pop DF into D:MSB
(1)      1B : FE                         shl                     ; restore DF
(1)      1C : 72                         ldxa                    ; pop D
(1)      1D : 70                         ret                     ; restore X,P IE=1
(1)      1E :                            ;; R1 points scrt_isr
(1)      1E :                    ;;; CDP1802 interrupt entry, X=2, P=1, IE=0
(1)      1E :                    ;;; @unchanged D, DF, X, P, R3, R15
(1)      1E :                    scrt_isr:
(1)      1E :                            ;; R2[0] must be preserved because it may be in the pop process
(1)      1E : 22                         dec     R2
(1)      1F : 78                         sav                     ; push X,P
(1)      20 : 22                         dec     R2
(1)      21 : 73                         stxd                    ; push D
(1)      22 : 76                         shrc                    ; MSB of D=DF
(1)      23 : 73                         stxd                    ; push DF
(1)      24 : 68 AF                      rsxd    R15             ; push scratch pad register R15
(1)      26 : 68 A3                      rsxd    R3              ; push program counter R3
(1)      28 : 68 C3 10 0C                rldi    R3, isr
(1)      2C : D3                         sep     R3              ; call interrupt service routine with P=3
(1)      2D : 30 15                      br      scrt_isr_exit   ; return from isr by SEP R1
         2F :
         2F :                    ;;; MC6850 Asynchronous Communication Interface Adapter
         2F : =4                 ACIA:   equ     4
         2F :                            include "mc6850.inc"
(1)      2F :                    ;;; -*- mode: asm; mode: flyspell-prog; -*-
(1)      2F :
(1)      2F :                    ;;; MC6850
(1)      2F :                    ;;; Asynchronous Communication Interface Adapter
(1)      2F :
(1)      2F :                    ;;; Control register
(1)      2F : =4                 ACIA_control:   equ     ACIA+0
(1)      2F :                            ;; Counter Divider Select Bits
(1)      2F : =3                 CDS_gm:         equ     11b    ; Group mask
(1)      2F : =0                 CDS_DIV1_gc:    equ     00000000B ; /1
(1)      2F : =1                 CDS_DIV16_gc:   equ     00000001B ; /16
(1)      2F : =2                 CDS_DIV64_gc:   equ     00000010B ; /64
(1)      2F : =3                 CDS_RESET_gc:   equ     00000011B ; Master Reset
(1)      2F :                            ;; Word Select Bits
(1)      2F : =1C                WSB_gm:         equ     00011100B ; Group mask
(1)      2F : =0                 WSB_7E2_gc:     equ     00000000B ; 7 Bits + Even Parity + 2 Stop Bits
(1)      2F : =4                 WSB_7O2_gc:     equ     00000100B ; 7 bits + Odd Parity  + 2 Stop Bits
(1)      2F : =8                 WSB_7E1_gc:     equ     00001000B ; 7 bits + Even Parity + 1 Stop Bits
(1)      2F : =C                 WSB_7O1_gc:     equ     00001100B ; 7 bits + Odd Parity  + 1 Stop Bits
(1)      2F : =10                WSB_8N2_gc:     equ     00010000B ; 8 bits + No Parity   + 2 Stop Bits
(1)      2F : =14                WSB_8N1_gc:     equ     00010100B ; 8 bits + No Parity   + 1 Stop Bits
(1)      2F : =18                WSB_8E1_gc:     equ     00011000B ; 8 bits + Even Parity + 1 Stop Bits
(1)      2F : =1C                WSB_8O1_gc:     equ     00011100B ; 8 bits + Odd Parity  + 1 Stop Bits
(1)      2F :                            ;; Transmit Control Bits
(1)      2F : =60                TCB_gm:         equ     01100000B ; Group mask
(1)      2F : =0                 TCB_DI_gc:      equ     00000000B ; RTS=Low,  Tx Interrupt Disabled
(1)      2F : =20                TCB_EI_gc:      equ     00100000B ; RTS=Low,  Tx Interrupt Enabled
(1)      2F : =40                TCB_RTS_gc:     equ     01000000B ; RTS=High, Tx Interrupt Disabled
(1)      2F : =60                TCB_BREAK_gc:   equ     01100000B ; RTS=Low,  Tx Interrupt Disabled
(1)      2F :                                                      ; Transmit Break Level
(1)      2F : =80                RIEB_bm:        equ     10000000B ; Receive Interrupt Enable Bit mask
(1)      2F :
(1)      2F :                    ;;; Status register
(1)      2F : =4                 ACIA_status:    equ     ACIA+0
(1)      2F : =1                 RDRF_bm:        equ     00000001B ; Receive Data Register Full
(1)      2F : =2                 TDRE_bm:        equ     00000010B ; Transmit Data Register Empty
(1)      2F : =4                 DCDF_bm:        equ     00000100B ; Data Carrier Detect Flag
(1)      2F : =8                 CTSF_bm:        equ     00001000B ; Clear To Send Flag
(1)      2F : =10                FERR_bm:        equ     00010000B ; Frame Error Flag
(1)      2F : =20                OVRN_bm:        equ     00100000B ; Receiver Overrun Flag
(1)      2F : =40                PERR_bm:        equ     01000000B ; Parity Error Flag
(1)      2F : =80                IRQF_bm:        equ     10000000B ; Interrupt Request Flag
(1)      2F :
(1)      2F :                    ;;; Data register
(1)      2F : =5                 ACIA_data:      equ     ACIA+1          ; Data register
         2F :
       1000 :                            org     X'1000'
       1000 : =FFF               stack:  equ     *-1
       1000 :                    main:
       1000 : 68 C8 10 0D                rldi    R8, ACIA_config
       1004 : E8                         sex     R8
       1005 : 64                         out     ACIA_control   ; Master reset
       1006 : 64                         out     ACIA_control   ; Set mode
       1007 : E2                         sex     R2
       1008 : 68 84 10 95                scal    R4, arith       ; call arith
       100C :                    isr:
       100C : 00                         idl
       100D :
       100D :                    ACIA_config:
       100D : 03                         dc      CDS_RESET_gc    ; Master reset
       100E : 14                         dc      WSB_8N1_gc      ; 8 bits + No Parity + 1 Stop Bits
       100F :                                                    ; Transmit, Receive interrupts disabled
       100F :                    ;;; Print out char
       100F :                    ;;; @param D char
       100F :                    ;;; @clobber R15.0
       100F :                    putchar_char:
       100F : 00                         dc      0
       1010 :                    putchar:
       1010 : AF                         plo     R15             ; save D to R15.0
       1011 : E2                         sex     R2
       1012 : 68 A8                      rsxd    R8              ; save R8
       1014 : 68 C8 10 0F                rldi    R8, putchar_char
       1018 : E8                         sex     R8              ; R8 for inp/out
       1019 :                    putchar_loop:
       1019 : 6C                         inp     ACIA_status
       101A : FA 02                      ani     TDRE_bm
       101C : 32 19                      bz      putchar_loop
       101E : 8F                         glo     R15             ; restore D
       101F : 58                         str     R8              ; send char
       1020 : 65                         out     ACIA_data
       1021 : E2                         sex     R2
       1022 : 60                         irx
       1023 : 68 68                      rlxa    R8              ; restore R8
       1025 : 22                         dec     R2
       1026 : 68 94                      sret    R4
       1028 :
       1028 :                    ;;; Print out newline
       1028 :                    ;;; @clobber D R15.0
       1028 :                    newline:
       1028 : F8 0D                      ldi     X'0D'
       102A : 68 84 10 10                scal    R4, putchar
       102E : F8 0A                      ldi     X'0A'
       1030 : 30 10                      br      putchar
       1032 :
       1032 :                    ;;; Print out space
       1032 :                    ;;; @clobber D R15.0
       1032 :                    putspace:
       1032 : F8 20                      ldi     T' '
       1034 : 30 10                      br      putchar
       1036 :
       1036 :                    ;;; Print out expression "operand1 operator operand2"
       1036 :                    ;;; @param R7 operand1
       1036 :                    ;;; @param R8 operand2
       1036 :                    ;;; @param D operator
       1036 :                    ;;; @clobber D R15
       1036 :                    expr:
       1036 : 68 A7                      rsxd    R7              ; save R7
       1038 : 73                         stxd                    ; save operator
       1039 : 68 84 12 E6                scal    R4, print_int16 ; print R7
       103D : 68 84 10 32                scal    R4, putspace
       1041 : 12                         inc     R2
       1042 : 02                         ldn     R2              ; restore operator
       1043 : 68 84 10 10                scal    R4, putchar     ; print operator
       1047 : 68 84 10 32                scal    R4, putspace
       104B : 98                         ghi     R8
       104C : B7                         phi     R7
       104D : 88                         glo     R8
       104E : A7                         plo     R7
       104F : 68 84 12 E6                scal    R4, print_int16 ; print R8
       1053 : 60                         irx
       1054 : 68 67                      rlxa    R7              ; restore R7
       1056 : 22                         dec     R2
       1057 : 68 94                      sret    R4
       1059 :
       1059 :                    ;;; Print out answer " = result\n"
       1059 :                    ;;; @params R7 result
       1059 :                    ;;; @clobber D R7 R15
       1059 :                    answer:
       1059 : 68 84 10 32                scal    R4, putspace
       105D : F8 3D                      ldi     T'='
       105F : 68 84 10 10                scal    R4, putchar
       1063 : 68 84 10 32                scal    R4, putspace
       1067 : 68 84 12 E6                scal    R4, print_int16
       106B : 30 28                      br      newline
       106D :
       106D :                    ;;; Compare 2 integers and print out "operand1 <=> operand2\n"
       106D :                    ;;; @param R7 operand1
       106D :                    ;;; @param R8 operand2
       106D :                    ;;; @clobber R15
       106D :                    comp:
       106D : 68 A7                      rsxd    R7              ; save R7
       106F : 68 A8                      rsxd    R8              ; save R8
       1071 : 68 84 13 57                scal    R4, cmp16
       1075 : 3B 87                      bl      comp_lt
       1077 : 32 83                      bz      comp_eq
       1079 : 33 7F                      bge     comp_gt
       107B : F8 3F                      ldi     T'?'
       107D : 30 89                      br      comp_out
       107F :                    comp_gt:
       107F : F8 3E                      ldi     T'>'
       1081 : 30 89                      br      comp_out
       1083 :                    comp_eq:
       1083 : F8 3D                      ldi     T'='
       1085 : 30 89                      br      comp_out
       1087 :                    comp_lt:
       1087 : F8 3C                      ldi     T'<'
       1089 :                    comp_out:
       1089 : 60                         irx
       108A : 68 68                      rlxa    R8              ; restore R8
       108C : 68 67                      rlxa    R7              ; restore R7
       108E : 22                         dec     R2
       108F : 68 84 10 36                scal    R4, expr
       1093 : 30 28                      br      newline
       1095 :
       1095 :                    arith:
       1095 : 68 C7 00 00                rldi    R7, 0
       1099 : 68 C8 92 A0                rldi    R8, -28000
       109D : F8 2D                      ldi     T'-'
       109F : 68 84 10 36                scal    R4, expr
       10A3 : 68 84 13 4B                scal    R4, sub16
       10A7 : 68 84 10 59                scal    R4, answer      ; 28000
       10AB :
       10AB : 68 C7 00 00                rldi    R7, 0
       10AF : 68 C8 6D 60                rldi    R8, 28000
       10B3 : F8 2D                      ldi     T'-'
       10B5 : 68 84 10 36                scal    R4, expr
       10B9 : 68 84 13 4B                scal    R4, sub16
       10BD : 68 84 10 59                scal    R4, answer      ; -28000
       10C1 :
       10C1 : 68 C7 46 50                rldi    R7, 18000
       10C5 : 68 C8 6D 60                rldi    R8, 28000
       10C9 : F8 2B                      ldi     T'+'
       10CB : 68 84 10 36                scal    R4, expr
       10CF : 68 84 13 3F                scal    R4, add16
       10D3 : 68 84 10 59                scal    R4, answer      ; -19536
       10D7 :
       10D7 : 68 C7 46 50                rldi    R7, 18000
       10DB : 68 C8 B9 B0                rldi    R8, -18000
       10DF : F8 2B                      ldi     T'+'
       10E1 : 68 84 10 36                scal    R4, expr
       10E5 : 68 84 13 3F                scal    R4, add16
       10E9 : 68 84 10 59                scal    R4, answer      ; 0
       10ED :
       10ED : 68 C7 B9 B0                rldi    R7, -18000
       10F1 : 68 C8 B9 B0                rldi    R8, -18000
       10F5 : F8 2B                      ldi     T'+'
       10F7 : 68 84 10 36                scal    R4, expr
       10FB : 68 84 13 3F                scal    R4, add16
       10FF : 68 84 10 59                scal    R4, answer      ; 29536
       1103 :
       1103 : 68 C7 46 50                rldi    R7, 18000
       1107 : 68 C8 92 A0                rldi    R8, -28000
       110B : F8 2D                      ldi     T'-'
       110D : 68 84 10 36                scal    R4, expr
       1111 : 68 84 13 4B                scal    R4, sub16
       1115 : 68 84 10 59                scal    R4, answer      ; -19536
       1119 :
       1119 : 68 C7 46 50                rldi    R7, 18000
       111D : 68 C8 B9 B0                rldi    R8, -18000
       1121 : F8 2D                      ldi     T'-'
       1123 : 68 84 10 36                scal    R4, expr
       1127 : 68 84 13 4B                scal    R4, sub16
       112B : 68 84 10 59                scal    R4, answer      ; 29536
       112F :
       112F : 68 C7 92 A0                rldi    R7, -28000
       1133 : 68 C8 B9 B0                rldi    R8, -18000
       1137 : F8 2D                      ldi     T'-'
       1139 : 68 84 10 36                scal    R4, expr
       113D : 68 84 13 4B                scal    R4, sub16
       1141 : 68 84 10 59                scal    R4, answer      ; -10000
       1145 :
       1145 : 68 C7 00 64                rldi    R7, 100
       1149 : 68 C8 01 2C                rldi    R8, 300
       114D : F8 2A                      ldi     T'*'
       114F : 68 84 10 36                scal    R4, expr
       1153 : 68 84 13 AC                scal    R4, mul16
       1157 : 68 84 10 59                scal    R4, answer      ; 30000
       115B :
       115B : 68 C7 00 C8                rldi    R7, 200
       115F : 68 C8 FF 9C                rldi    R8, -100
       1163 : F8 2A                      ldi     T'*'
       1165 : 68 84 10 36                scal    R4, expr
       1169 : 68 84 13 AC                scal    R4, mul16
       116D : 68 84 10 59                scal    R4, answer      ; -20000
       1171 :
       1171 : 68 C7 01 2C                rldi    R7, 300
       1175 : 68 C8 FF 38                rldi    R8, -200
       1179 : F8 2A                      ldi     T'*'
       117B : 68 84 10 36                scal    R4, expr
       117F : 68 84 13 AC                scal    R4, mul16
       1183 : 68 84 10 59                scal    R4, answer      ; 5536
       1187 :
       1187 : 68 C7 FF 9C                rldi    R7, -100
       118B : 68 C8 01 2C                rldi    R8, 300
       118F : F8 2A                      ldi     T'*'
       1191 : 68 84 10 36                scal    R4, expr
       1195 : 68 84 13 AC                scal    R4, mul16
       1199 : 68 84 10 59                scal    R4, answer      ; -30000
       119D :
       119D : 68 C7 FF 38                rldi    R7, -200
       11A1 : 68 C8 FF 9C                rldi    R8, -100
       11A5 : F8 2A                      ldi     T'*'
       11A7 : 68 84 10 36                scal    R4, expr
       11AB : 68 84 13 AC                scal    R4, mul16
       11AF : 68 84 10 59                scal    R4, answer      ; 20000
       11B3 :
       11B3 : 68 C7 75 30                rldi    R7, 30000
       11B7 : 68 C8 00 64                rldi    R8, 100
       11BB : F8 2F                      ldi     T'/'
       11BD : 68 84 10 36                scal    R4, expr
       11C1 : 68 84 14 3A                scal    R4, div16
       11C5 : 68 84 10 59                scal    R4, answer      ; 30
       11C9 :
       11C9 : 68 C7 FF 38                rldi    R7, -200
       11CD : 68 C8 00 64                rldi    R8, 100
       11D1 : F8 2F                      ldi     T'/'
       11D3 : 68 84 10 36                scal    R4, expr
       11D7 : 68 84 14 3A                scal    R4, div16
       11DB : 68 84 10 59                scal    R4, answer      ; -2
       11DF :
       11DF : 68 C7 8A D0                rldi    R7, -30000
       11E3 : 68 C8 FF 38                rldi    R8, -200
       11E7 : F8 2F                      ldi     T'/'
       11E9 : 68 84 10 36                scal    R4, expr
       11ED : 68 84 14 3A                scal    R4, div16
       11F1 : 68 84 10 59                scal    R4, answer      ; 150
       11F5 :
       11F5 : 68 C7 8A D0                rldi    R7, -30000
       11F9 : 68 C8 00 4E                rldi    R8, 78
       11FD : F8 2F                      ldi     T'/'
       11FF : 68 84 10 36                scal    R4, expr
       1203 : 68 84 14 3A                scal    R4, div16
       1207 : 68 84 10 59                scal    R4, answer      ; -384
       120B :
       120B : 68 C7 13 88                rldi    R7, 5000
       120F : 68 C8 0F A0                rldi    R8, 4000
       1213 : 68 84 10 6D                scal    R4, comp
       1217 :
       1217 : 68 C7 13 88                rldi    R7, 5000
       121B : 68 C8 13 88                rldi    R8, 5000
       121F : 68 84 10 6D                scal    R4, comp
       1223 :
       1223 : 68 C7 0F A0                rldi    R7, 4000
       1227 : 68 C8 13 88                rldi    R8, 5000
       122B : 68 84 10 6D                scal    R4, comp
       122F :
       122F : 68 C7 EC 78                rldi    R7, -5000
       1233 : 68 C8 F0 60                rldi    R8, -4000
       1237 : 68 84 10 6D                scal    R4, comp
       123B :
       123B : 68 C7 EC 78                rldi    R7, -5000
       123F : 68 C8 EC 78                rldi    R8, -5000
       1243 : 68 84 10 6D                scal    R4, comp
       1247 :
       1247 : 68 C7 F0 60                rldi    R7, -4000
       124B : 68 C8 EC 78                rldi    R8, -5000
       124F : 68 84 10 6D                scal    R4, comp
       1253 :
       1253 : 68 C7 7F BC                rldi    R7, 32700
       1257 : 68 C8 7F 58                rldi    R8, 32600
       125B : 68 84 10 6D                scal    R4, comp
       125F :
       125F : 68 C7 7F BC                rldi    R7, 32700
       1263 : 68 C8 7F BC                rldi    R8, 32700
       1267 : 68 84 10 6D                scal    R4, comp
       126B :
       126B : 68 C7 7F 58                rldi    R7, 32600
       126F : 68 C8 7F BC                rldi    R8, 32700
       1273 : 68 84 10 6D                scal    R4, comp
       1277 :
       1277 : 68 C7 80 44                rldi    R7, -32700
       127B : 68 C8 80 A8                rldi    R8, -32600
       127F : 68 84 10 6D                scal    R4, comp
       1283 :
       1283 : 68 C7 80 44                rldi    R7, -32700
       1287 : 68 C8 80 44                rldi    R8, -32700
       128B : 68 84 10 6D                scal    R4, comp
       128F :
       128F : 68 C7 80 A8                rldi    R7, -32600
       1293 : 68 C8 80 44                rldi    R8, -32700
       1297 : 68 84 10 6D                scal    R4, comp
       129B :
       129B : 68 C7 46 50                rldi    R7, 18000
       129F : 68 C8 92 A0                rldi    R8, -28000
       12A3 : 68 84 10 6D                scal    R4, comp
       12A7 :
       12A7 : 68 C7 92 A0                rldi    R7, -28000
       12AB : 68 C8 92 A0                rldi    R8, -28000
       12AF : 68 84 10 6D                scal    R4, comp
       12B3 :
       12B3 : 68 C7 92 A0                rldi    R7, -28000
       12B7 : 68 C8 46 50                rldi    R8, 18000
       12BB : 68 84 10 6D                scal    R4, comp
       12BF :
       12BF : 68 94                      sret    R4
       12C1 :
       12C1 :                            include "arith.inc"
(1)    12C1 :                    ;;; -*- mode: asm; mode: flyspell-prog; -*-
(1)    12C1 :                            cpu     1804A
(1)    12C1 :
(1)    12C1 :                    ;;; Print unsigned 16-bit integer as decimal
(1)    12C1 :                    ;;; @param R7 value
(1)    12C1 :                    ;;; @clobber D R7 R8 R15
(1)    12C1 :                    print_uint16:
(1)    12C1 : 97                         ghi     R7
(1)    12C2 : 3A C7                      bnz     print_uint16_loop
(1)    12C4 : 87                         glo     R7
(1)    12C5 : 32 E1                      bz      print_uint16_zero
(1)    12C7 :                    print_uint16_loop:
(1)    12C7 : 97                         ghi     R7
(1)    12C8 : 3A CF                      bnz     print_uint16_digit
(1)    12CA : 87                         glo     R7
(1)    12CB : 3A CF                      bnz     print_uint16_digit
(1)    12CD : 68 94                      sret    R4
(1)    12CF :                    print_uint16_digit:
(1)    12CF : F8 00                      ldi     0
(1)    12D1 : B8                         phi     R8
(1)    12D2 : F8 0A                      ldi     10
(1)    12D4 : A8                         plo     R8              ; divisor=10
(1)    12D5 : 68 84 13 E2                scal    R4, udiv16
(1)    12D9 : 88                         glo     R8
(1)    12DA : 73                         stxd                    ; push remainder
(1)    12DB : 68 84 12 C7                scal    R4, print_uint16_loop
(1)    12DF : 12                         inc     R2
(1)    12E0 : 02                         ldn     R2              ; pop remainder
(1)    12E1 :                    print_uint16_zero:
(1)    12E1 : FC 30                      adi     T'0'
(1)    12E3 : C0 10 10                   br      putchar
(1)    12E6 :
(1)    12E6 :                    ;;; Print signed 16-bit integer as decimal
(1)    12E6 :                    ;;; @param R7 value
(1)    12E6 :                    ;;; @clobber D R15
(1)    12E6 :                    print_int16:
(1)    12E6 : 68 A8                      rsxd    R8              ; save R8
(1)    12E8 : 68 A7                      rsxd    R7              ; save R7
(1)    12EA : 97                         ghi     R7
(1)    12EB : FA 80                      ani     X'80'
(1)    12ED : 32 FE                      bz      print_int16_print
(1)    12EF : F8 2D                      ldi     T'-'
(1)    12F1 : 68 84 10 10                scal    R4, putchar      ; print '-'
(1)    12F5 : 97                         ghi     R7
(1)    12F6 : FB FF                      xri     X'FF'
(1)    12F8 : B7                         phi     R7
(1)    12F9 : 87                         glo     R7
(1)    12FA : FB FF                      xri     X'FF'
(1)    12FC : A7                         plo     R7
(1)    12FD : 17                         inc     R7              ; negate value
(1)    12FE :                    print_int16_print:
(1)    12FE : 68 84 12 C1                scal    R4, print_uint16
(1)    1302 : 60                         irx
(1)    1303 : 68 67                      rlxa    R7              ; restore R7
(1)    1305 : 68 68                      rlxa    R8              ; restore R8
(1)    1307 : 22                         dec     R2
(1)    1308 : 68 94                      sret    R4
(1)    130A :
(1)    130A :                    ;;; Store R7 to variable
(1)    130A :                    ;;;   SCAL R4, store_R7
(1)    130A :                    ;;;   DC   A(variable)
(1)    130A :                    ;;; @clobber D
(1)    130A :                    store_R7:
(1)    130A : 68 A8                      rsxd    R8              ; save R8
(1)    130C : E4                         sex     R4
(1)    130D : 68 68                      rlxa    R8              ; R8=&valiable
(1)    130F : E8                         sex     R8
(1)    1310 : 60                         irx
(1)    1311 : 68 A7                      rsxd    R7
(1)    1313 : E2                         sex     R2
(1)    1314 : 60                         irx
(1)    1315 : 68 68                      rlxa    R8              ; restore R8
(1)    1317 : 22                         dec     R2
(1)    1318 : 68 94                      sret    R4
(1)    131A :
(1)    131A :                    ;;; Load variable to R7
(1)    131A :                    ;;;   SCAL R4, load_R7
(1)    131A :                    ;;;   DC   A(variable)
(1)    131A :                    ;;; @return R7 variable
(1)    131A :                    ;;; @clobber R15
(1)    131A :                    load_R7:
(1)    131A : E4                         sex     R4
(1)    131B : 68 67                      rlxa    R7              ; R7=&variable
(1)    131D : E7                         sex     R7
(1)    131E : 68 67                      rlxa    R7
(1)    1320 : E2                         sex     R2
(1)    1321 : 68 94                      sret    R4
(1)    1323 :
(1)    1323 :                    ;;; Load variable to R8
(1)    1323 :                    ;;;   SCAL R4, load_R8
(1)    1323 :                    ;;;   DC   A(variable)
(1)    1323 :                    ;;; @clobber R15
(1)    1323 :                    load_R8:
(1)    1323 : E4                         sex     R4
(1)    1324 : 68 68                      rlxa    R8              ; R8=&variable
(1)    1326 : E8                         sex     R8
(1)    1327 : 68 68                      rlxa    R8
(1)    1329 : E2                         sex     R2
(1)    132A : 68 94                      sret    R4
(1)    132C :
(1)    132C :                    ;;; Increment variable
(1)    132C :                    ;;;   SCAL R4, inc16
(1)    132C :                    ;;;   DC   A(variable)
(1)    132C :                    ;;; @return R7 variable
(1)    132C :                    inc16:
(1)    132C : 68 A8                      rsxd    R8              ; save R8
(1)    132E : E4                         sex     R4
(1)    132F : 68 68                      rlxa    R8              ; R8=$variable
(1)    1331 : E8                         sex     R8
(1)    1332 : 68 67                      rlxa    R7              ; load R7
(1)    1334 : 17                         inc     R7
(1)    1335 : 28                         dec     R8
(1)    1336 : 68 A7                      rsxd    R7              ; save R7
(1)    1338 : E2                         sex     R2
(1)    1339 : 60                         irx
(1)    133A : 68 68                      rlxa    R8              ; restore R8
(1)    133C : 22                         dec     R2
(1)    133D : 68 94                      sret    R4
(1)    133F :
(1)    133F :                    ;;; Signed addition: summand += addend
(1)    133F :                    ;;; @param R7 summand
(1)    133F :                    ;;; @param R8 addend
(1)    133F :                    ;;; @return R7 summand + addend
(1)    133F :                    ;;;   SCAL R4, add16
(1)    133F :                    ;;; @clobber D
(1)    133F :                    add16:
(1)    133F : 88                         glo     R8
(1)    1340 : 52                         str     R2
(1)    1341 : 87                         glo     R7
(1)    1342 : F4                         add
(1)    1343 : A7                         plo     R7
(1)    1344 : 98                         ghi     R8
(1)    1345 : 52                         str     R2
(1)    1346 : 97                         ghi     R7
(1)    1347 : 74                         adc
(1)    1348 : B7                         phi     R7
(1)    1349 : 68 94                      sret    R4
(1)    134B :
(1)    134B :                    ;;; Singed subtraction: minuend -= subtrahend
(1)    134B :                    ;;;   SCAL R4, sub16
(1)    134B :                    ;;; @param R7 minuend
(1)    134B :                    ;;; @param R8 subtrahend
(1)    134B :                    ;;; @return R7 minuend - subtrahend
(1)    134B :                    ;;; @clobber D
(1)    134B :                    sub16:
(1)    134B : 88                         glo     R8
(1)    134C : 52                         str     R2
(1)    134D : 87                         glo     R7
(1)    134E : F7                         sm
(1)    134F : A7                         plo     R7
(1)    1350 : 98                         ghi     R8
(1)    1351 : 52                         str     R2
(1)    1352 : 97                         ghi     R7
(1)    1353 : 77                         smb
(1)    1354 : B7                         phi     R7
(1)    1355 : 68 94                      sret    R4
(1)    1357 :
(1)    1357 :                    ;;; Signed comparison: minuend - subtrahend
(1)    1357 :                    ;;; @param R7 minuend
(1)    1357 :                    ;;; @param R8 subtrahend
(1)    1357 :                    ;;; @return D=0 DF=1 (minuend==subtrahend); BZ
(1)    1357 :                    ;;;         D=1 DF=1 (minuend>subtrahend);  BGE
(1)    1357 :                    ;;;         D=1 DF=0 (minuend<subtrahend);  BL
(1)    1357 :                    ;;; @clobber R7 R8
(1)    1357 :                    ;;; result = minuend - subtrahend
(1)    1357 :                    ;;; Z=(result.1 | result.0) == 0
(1)    1357 :                    ;;; N=(result.1 & 0x80) != 0
(1)    1357 :                    ;;; V=((minuend.1 ^ subtrahend.1) & (result.1 ^ minuend.1) & 0x80) != 0
(1)    1357 :                    ;;; LT=N ^ V
(1)    1357 :                    cmp16:
(1)    1357 : 88                         glo     R8              ; D=subtrahend.0
(1)    1358 : 52                         str     R2              ; stack top=subtrahend.0
(1)    1359 : 87                         glo     R7              ; D=minuend.0
(1)    135A : F7                         sm                      ; D=minuend.0=subtrahend.0
(1)    135B : A7                         plo     R7              ; R7.0=result.0
(1)    135C : 98                         ghi     R8              ; D=subtrahend.1
(1)    135D : 52                         str     R2              ; stack top=subtrahend.1
(1)    135E : 97                         ghi     R7              ; D=minuend.1
(1)    135F : F3                         xor                     ; D=minuend.1^subtrahend.1
(1)    1360 : A8                         plo     R8              ; R8.0=minuend.1^subtrahend.1
(1)    1361 : 97                         ghi     R7              ; D=minuend.1
(1)    1362 : 77                         smb                     ; D=minuend.1=subtrahend.1
(1)    1363 : B8                         phi     R8              ; R8.1=result.1
(1)    1364 : 3A 6E                      bnz     cmp16_neq       ; branch if result.1!=0
(1)    1366 : 87                         glo     R7              ; D=result.0
(1)    1367 : 3A 6E                      bnz     cmp16_neq       ; branch if result.0!=-
(1)    1369 : F8 01                      ldi     1
(1)    136B : F6                         shr
(1)    136C : 68 94                      sret    R4
(1)    136E :                    cmp16_neq:
(1)    136E : 98                         ghi     R8              ; D=result.1
(1)    136F : 52                         str     R2
(1)    1370 : 97                         ghi     R7              ; D=minuend.1
(1)    1371 : F3                         xor                     ; D=result.1^minuend.1
(1)    1372 : 52                         str     R2              ; stack top=result.1^minuend.1
(1)    1373 : 88                         glo     R8              ; D=minuend.1^subtrahend.1
(1)    1374 : F2                         and                     ; D=(minuend.1^subtrahend.1)&(result.1^minuend.1)
(1)    1375 : 52                         str     R2              ; stack top=V
(1)    1376 : 98                         ghi     R8              ; D=result.1
(1)    1377 : F3                         xor                     ; D=N^V
(1)    1378 : FB 80                      xri     X'80'           ; D=~(N^V)
(1)    137A : FE                         shl                     ; DF=~(N^V)
(1)    137B : F8 01                      ldi     1
(1)    137D : 68 94                      sret    R4
(1)    137F :
(1)    137F :                    ;;; Unsigned multiplication: result = multiplicand * multiplier
(1)    137F :                    ;;; @param R7 multiplicand
(1)    137F :                    ;;; @param R8 multiplier
(1)    137F :                    ;;; @return R7 result
(1)    137F :                    ;;; @clobber D R7 R8 R15
(1)    137F :                    umul16:
(1)    137F : F8 00                      ldi     0
(1)    1381 : BF                         phi     R15
(1)    1382 : AF                         plo     R15             ; R15=result
(1)    1383 : 30 A0                      br      umul16_check
(1)    1385 :                    umul16_loop:
(1)    1385 : 88                         glo     R8
(1)    1386 : FA 01                      ani     1
(1)    1388 : 32 94                      bz      umul16_sr       ; lsb(multiplier)==0
(1)    138A : 87                         glo     R7
(1)    138B : 52                         str     R2              ; stack top=multiplicand.0
(1)    138C : 8F                         glo     R15
(1)    138D : F4                         add
(1)    138E : AF                         plo     R15
(1)    138F : 97                         ghi     R7
(1)    1390 : 52                         str     R2              ; stack top=multiplicand.1
(1)    1391 : 9F                         ghi     R15
(1)    1392 : 74                         adc
(1)    1393 : BF                         phi     R15             ; result += multiplicand
(1)    1394 :                    umul16_sr:
(1)    1394 : 98                         ghi     R8
(1)    1395 : F6                         shr
(1)    1396 : B8                         phi     R8
(1)    1397 : 88                         glo     R8
(1)    1398 : 76                         shrc
(1)    1399 : A8                         plo     R8              ; multiplier >>= 1
(1)    139A : 87                         glo     R7
(1)    139B : FE                         shl
(1)    139C : A7                         plo     R7
(1)    139D : 97                         ghi     R7
(1)    139E : 7E                         shlc
(1)    139F : B7                         phi     R7              ; multiplicand <<= 1
(1)    13A0 :                    umul16_check:
(1)    13A0 : 98                         ghi     R8
(1)    13A1 : 3A 85                      bnz     umul16_loop     ; while multiplier != 0
(1)    13A3 : 88                         glo     R8
(1)    13A4 : 3A 85                      bnz     umul16_loop     ; while multiplier != 0
(1)    13A6 : 9F                         ghi     R15
(1)    13A7 : B7                         phi     R7
(1)    13A8 : 8F                         glo     R15
(1)    13A9 : A7                         plo     R7              ; R7=result
(1)    13AA : 68 94                      sret    R4
(1)    13AC :
(1)    13AC :                    ;;; Signed multiplication: multiplicand *= multiplier
(1)    13AC :                    ;;; @param R7 multiplicand
(1)    13AC :                    ;;; @param R8 multiplier
(1)    13AC :                    ;;; @return R7 multiplicand * multiplier
(1)    13AC :                    ;;;   SCAL R4, mul16
(1)    13AC :                    ;;; @clobber R8 R15
(1)    13AC :                    mul16:
(1)    13AC : 98                         ghi     R8
(1)    13AD : 52                         str     R2
(1)    13AE : 97                         ghi     R7
(1)    13AF : F3                         xor
(1)    13B0 : 73                         stxd                    ; push sign
(1)    13B1 : 98                         ghi     R8
(1)    13B2 : FA 80                      ani     X'80'
(1)    13B4 : 32 BF                      bz      mul16_multiplicand
(1)    13B6 : 98                         ghi     R8
(1)    13B7 : FB FF                      xri     X'FF'
(1)    13B9 : B8                         phi     R8
(1)    13BA : 88                         glo     R8
(1)    13BB : FB FF                      xri     X'FF'
(1)    13BD : A8                         plo     R8
(1)    13BE : 18                         inc     R8              ; negate multiplier
(1)    13BF :                    mul16_multiplicand:
(1)    13BF : 97                         ghi     R7
(1)    13C0 : FA 80                      ani     X'80'
(1)    13C2 : 32 CD                      bz      mul16_multiply
(1)    13C4 : 97                         ghi     R7
(1)    13C5 : FB FF                      xri     X'FF'
(1)    13C7 : B7                         phi     R7
(1)    13C8 : 87                         glo     R7
(1)    13C9 : FB FF                      xri     X'FF'
(1)    13CB : A7                         plo     R7
(1)    13CC : 17                         inc     R7              ; negate multiplicand
(1)    13CD :                    mul16_multiply:
(1)    13CD : 68 84 13 7F                scal    R4, umul16
(1)    13D1 : 60                         irx
(1)    13D2 : F0                         ldx                     ; sign
(1)    13D3 : FA 80                      ani     X'80'
(1)    13D5 : 32 E0                      bz      mul16_return
(1)    13D7 : 97                         ghi     R7
(1)    13D8 : FB FF                      xri     X'FF'
(1)    13DA : B7                         phi     R7
(1)    13DB : 87                         glo     R7
(1)    13DC : FB FF                      xri     X'FF'
(1)    13DE : A7                         plo     R7
(1)    13DF : 17                         inc     R7              ; negate result
(1)    13E0 :                    mul16_return:
(1)    13E0 : 68 94                      sret    R4
(1)    13E2 :
(1)    13E2 :                    ;;; Unsigned division: dividend / divisor = quotient ... remainder
(1)    13E2 :                    ;;; @praram R7 dividend
(1)    13E2 :                    ;;; @praram R8 divisor
(1)    13E2 :                    ;;; @return R7 quotient
(1)    13E2 :                    ;;; @return R8 remainder
(1)    13E2 :                    ;;; @clobber R7 R8 R15
(1)    13E2 :                    udiv16:
(1)    13E2 : 98                         ghi     R8
(1)    13E3 : 3A EA                      bnz     udiv16_calc
(1)    13E5 : 88                         glo     R8
(1)    13E6 : 3A EA                      bnz     udiv16_calc
(1)    13E8 : 68 94                      sret    R4
(1)    13EA :                    udiv16_calc:
(1)    13EA : 68 A9                      rsxd    R9              ; save R9
(1)    13EC : F8 01                      ldi     1
(1)    13EE : AF                         plo     R15             ; R15.0=bits
(1)    13EF : 30 F8                      br      udiv16_prep
(1)    13F1 :                    udiv16_prep_loop:
(1)    13F1 : 88                         glo     R8
(1)    13F2 : FE                         shl
(1)    13F3 : A8                         plo     R8
(1)    13F4 : 98                         ghi     R8
(1)    13F5 : 7E                         shlc
(1)    13F6 : B8                         phi     R8              ; divisor <<= 1
(1)    13F7 : 1F                         inc     R15             ; ++bits
(1)    13F8 :                    udiv16_prep:
(1)    13F8 : 98                         ghi     R8
(1)    13F9 : FA 80                      ani     X'80'
(1)    13FB : 32 F1                      bz      udiv16_prep_loop ; while msb(divisor) == 0
(1)    13FD : 97                         ghi     R7
(1)    13FE : B9                         phi     R9
(1)    13FF : 87                         glo     R7
(1)    1400 : A9                         plo     R9              ; R9=dividend
(1)    1401 : F8 00                      ldi     0
(1)    1403 : B7                         phi     R7
(1)    1404 : A7                         plo     R7              ; R7=quotient
(1)    1405 : 30 13                      br      udiv16_enter_loop
(1)    1407 :                    udiv16_loop:
(1)    1407 : 98                         ghi     R8
(1)    1408 : F6                         shr
(1)    1409 : B8                         phi     R8
(1)    140A : 88                         glo     R8
(1)    140B : 76                         shrc
(1)    140C : A8                         plo     R8              ; divisor >>= 1
(1)    140D : 87                         glo     R7
(1)    140E : FE                         shl
(1)    140F : A7                         plo     R7
(1)    1410 : 97                         ghi     R7
(1)    1411 : 7E                         shlc
(1)    1412 : B7                         phi     R7              ; quotient <<= 1
(1)    1413 :                    udiv16_enter_loop:
(1)    1413 : 88                         glo     R8
(1)    1414 : 52                         str     R2
(1)    1415 : 89                         glo     R9
(1)    1416 : F7                         sm
(1)    1417 : A9                         plo     R9
(1)    1418 : 98                         ghi     R8
(1)    1419 : 52                         str     R2
(1)    141A : 99                         ghi     R9
(1)    141B : 77                         smb
(1)    141C : B9                         phi     R9              ; dividend-=divisor
(1)    141D : 3B 22                      bm      udiv16_readd    ; branch if dividend < 0
(1)    141F : 17                         inc     R7              ; quotient += 1
(1)    1420 : 30 2C                      br      udiv16_next
(1)    1422 :                    udiv16_readd:
(1)    1422 : 88                         glo     R8
(1)    1423 : 52                         str     R2
(1)    1424 : 89                         glo     R9
(1)    1425 : F4                         add
(1)    1426 : A9                         plo     R9
(1)    1427 : 98                         ghi     R8
(1)    1428 : 52                         str     R2
(1)    1429 : 99                         ghi     R9
(1)    142A : 74                         adc
(1)    142B : B9                         phi     R9              ; dividend+=divisor
(1)    142C :                    udiv16_next:
(1)    142C : 2F                         dec     R15
(1)    142D : 8F                         glo     R15
(1)    142E : 3A 07                      bnz     udiv16_loop     ; while bits != 0
(1)    1430 : 99                         ghi     R9
(1)    1431 : B8                         phi     R8
(1)    1432 : 89                         glo     R9
(1)    1433 : A8                         plo     R8              ; R8=remainder
(1)    1434 : 60                         irx
(1)    1435 : 68 69                      rlxa    R9              ; restore R9
(1)    1437 : 22                         dec     R2
(1)    1438 : 68 94                      sret    R4
(1)    143A :
(1)    143A :                    ;;; Signed division: dividend / divisor = quotient ... remainder
(1)    143A :                    ;;; @param R7 dividend
(1)    143A :                    ;;; @param R8 divisor
(1)    143A :                    ;;; @return R7 quotient
(1)    143A :                    ;;; @return R8 remainder
(1)    143A :                    ;;;   SCAL R4, duvsi2
(1)    143A :                    ;;;   SEP R5
(1)    143A :                    ;;;   DC  A(div16)
(1)    143A :                    ;;; @clobber R15
(1)    143A :                    div16:
(1)    143A : 98                         ghi     R8
(1)    143B : 52                         str     R2
(1)    143C : 97                         ghi     R7
(1)    143D : F3                         xor
(1)    143E : 73                         stxd                    ; push sign
(1)    143F : 98                         ghi     R8
(1)    1440 : FA 80                      ani     X'80'
(1)    1442 : 32 4D                      bz      div16_dividend
(1)    1444 : 98                         ghi     R8
(1)    1445 : FB FF                      xri     X'FF'
(1)    1447 : B8                         phi     R8
(1)    1448 : 88                         glo     R8
(1)    1449 : FB FF                      xri     X'FF'
(1)    144B : A8                         plo     R8
(1)    144C : 18                         inc     R8              ; negate divisor
(1)    144D :                    div16_dividend:
(1)    144D : 97                         ghi     R7              ; R7=dividend
(1)    144E : FA 80                      ani     X'80'
(1)    1450 : 32 5B                      bz      div16_divide
(1)    1452 : 97                         ghi     R7
(1)    1453 : FB FF                      xri     X'FF'
(1)    1455 : B7                         phi     R7
(1)    1456 : 87                         glo     R7
(1)    1457 : FB FF                      xri     X'FF'
(1)    1459 : A7                         plo     R7
(1)    145A : 17                         inc     R7              ; negate dividend
(1)    145B :                    div16_divide:
(1)    145B : 68 84 13 E2                scal    R4, udiv16
(1)    145F : 60                         irx
(1)    1460 : F0                         ldx                     ; pop sign
(1)    1461 : FA 80                      ani     X'80'
(1)    1463 : 32 6E                      bz      div16_return
(1)    1465 : 97                         ghi     R7
(1)    1466 : FB FF                      xri     X'FF'
(1)    1468 : B7                         phi     R7
(1)    1469 : 87                         glo     R7
(1)    146A : FB FF                      xri     X'FF'
(1)    146C : A7                         plo     R7
(1)    146D : 17                         inc     R7              ; negate quotient
(1)    146E :                    div16_return:
(1)    146E : 68 94                      sret    R4
       1470 :
       1470 :                            end
